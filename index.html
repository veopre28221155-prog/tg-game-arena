<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .card { background: #f0f0f2; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .btn { background: #2481cc; color: #fff; border: none; border-radius: 10px; padding: 15px; width: 100%; font-size: 16px; font-weight: bold; }
        #log { font-size: 10px; color: red; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="name">Загрузка...</h2>
        <div style="font-size: 30px;">⭐ <span id="balance">0</span></div>
    </div>
    <button class="btn" onclick="makeOrder()">ПОПОЛНИТЬ БАЛАНС (50 XTR)</button>
    <div id="log"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const API = 'https://tg-game-arena.onrender.com';
        tg.expand();

        function debug(msg) { document.getElementById('log').innerText += msg + '\n'; }

        async function load() {
            try {
                debug("Запрос данных пользователя...");
                const r = await fetch(`${API}/api/user-data`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData })
                });
                const d = await r.json();
                document.getElementById('name').innerText = d.name;
                document.getElementById('balance').innerText = d.balance;
                debug("Данные загружены ✅");
            } catch(e) { debug("Ошибка загрузки: " + e.message); }
        }

        async function makeOrder() {
            debug("Создание счета...");
            try {
                const r = await fetch(`${API}/api/create-invoice`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData, amount: 50 })
                });
                const res = await r.json();
                if (res.invoiceLink) {
                    debug("Счет создан, открываю оплату...");
                    tg.openInvoice(res.invoiceLink, (status) => {
                        debug("Статус оплаты: " + status);
                        if(status === 'paid') load();
                    });
                } else { debug("Ошибка: Сервер не дал ссылку"); }
            } catch(e) { debug("Ошибка сети: " + e.message); }
        }
        load();
    </script>
</body>
</html>
