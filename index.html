<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #1a1a1a; --btn: #2481cc; --card: #2c2c2c; --text: #ffffff; --accent: #00ff41; }
        body { background: #000; color: var(--text); margin: 0; font-family: sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        .screen { display: none; flex: 1; padding: 15px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }
        .card { background: var(--card); border-radius: 15px; width: 100%; padding: 20px; margin-bottom: 10px; text-align: center; box-sizing: border-box; }
        .btn { background: var(--btn); color: #fff; border: none; border-radius: 10px; padding: 15px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; margin: 5px 0; }
        input { width: 80%; padding: 12px; border-radius: 8px; border: none; margin-bottom: 10px; text-align: center; font-size: 18px; color: #000; }
        canvas { background: #000; border: 2px solid #444; border-radius: 8px; display: none; margin: 0 auto; }
        #nav { display: flex; background: #111; height: 70px; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; font-size: 14px; }
        .nav-item.active { color: var(--btn); font-weight: bold; }
        #overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:100; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>
<div id="app">
    <div id="overlay">
        <h2 id="res-title">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
        <p id="res-score" style="font-size:32px; color:var(--accent);">0</p>
        <button class="btn" style="width:200px" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>

    <div id="arena" class="screen active">
        <div class="card">
            <h3>–í–´–ë–ï–†–ò–¢–ï –ò–ì–†–£</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="btn-s" onclick="setGame('snake')">üêç –ó–ú–ï–ô–ö–ê</button>
                <button class="btn" id="btn-t" style="opacity:0.5" onclick="setGame('tetris')">üß± –¢–ï–¢–†–ò–°</button>
            </div>
        </div>
        <div id="menu-box" class="card">
            <h4 id="mode-info">–†–ï–ñ–ò–ú: –¢–†–ï–ù–ò–†–û–í–ö–ê</h4>
            <button class="btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
            <button class="btn" style="background:#444" id="friend-btn">‚öîÔ∏è –° –î–†–£–ì–û–ú</button>
        </div>
        <div id="game-box" style="display:none; text-align:center;">
            <div id="score-val" style="font-size:20px; margin-bottom:10px; color:var(--accent);">–°–ß–ï–¢: 0</div>
            <canvas id="canvas" width="240" height="400"></canvas>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">–ó–ê–ì–†–£–ó–ö–ê...</h2>
            <div style="font-size:40px; color: gold;">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <div class="card">
            <h4>–ü–û–ü–û–õ–ù–ï–ù–ò–ï</h4>
            <input type="number" id="pay-amount" value="50">
            <button class="btn" onclick="buyStars()">–ö–£–ü–ò–¢–¨ STARS</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="showTab('arena', this)">–ê–†–ï–ù–ê</div>
        <div class="nav-item" onclick="tab('profile', this)">–ü–†–û–§–ò–õ–¨</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', move = {x:1, y:0}, score = 0, loop = null;
    let isPractice = true, currentLobbyId = null;
    
    let tBoard, tPiece;
    const COLS = 10, ROWS = 20, BLOCK = 24;

    async function loadUser() {
        try {
            const r = await fetch(`${API}/api/user-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
            const d = await r.json();
            document.getElementById('u-name').innerText = d.name.toUpperCase();
            document.getElementById('u-balance').innerText = d.balance;
        } catch(e) { console.error("API Error"); }
    }

    async function checkInvite() {
        const startParam = tg.initDataUnsafe.start_param;
        if (startParam && startParam.startsWith('lobby_')) {
            currentLobbyId = startParam.replace('lobby_', '');
            isPractice = false;
            try {
                await fetch(`${API}/api/join-lobby`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId })
                });
                document.getElementById('mode-info').innerHTML = `<b style="color:#ff4141">‚öîÔ∏è –†–ï–ñ–ò–ú: –î–£–≠–õ–¨</b>`;
                tg.MainButton.setText('–í –ë–û–ô!').show().onClick(() => startGame());
            } catch(e) { console.error("Lobby Error"); }
        }
    }

    document.getElementById('friend-btn').onclick = () => {
        const id = Math.random().toString(36).substr(2, 7);
        tg.switchInlineQuery(`lobby_${id}`, ['users', 'chats']);
    };

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id == 'profile') loadUser();
    }

    function setGame(type) { 
        currentGame = type; 
        document.getElementById('btn-s').style.opacity = type == 'snake' ? '1' : '0.5';
        document.getElementById('btn-t').style.opacity = type == 'tetris' ? '1' : '0.5';
    }

    window.addEventListener('keydown', e => {
        if(currentGame == 'snake') {
            if(e.key == 'ArrowUp' && move.y == 0) move = {x:0, y:-1};
            if(e.key == 'ArrowDown' && move.y == 0) move = {x:0, y:1};
            if(e.key == 'ArrowLeft' && move.x == 0) move = {x:-1, y:0};
            if(e.key == 'ArrowRight' && move.x == 0) move = {x:1, y:0};
        } else {
            if(e.key == 'ArrowLeft') moveTetris(-1);
            if(e.key == 'ArrowRight') moveTetris(1);
            if(e.key == 'ArrowDown') dropTetris();
            if(e.key == 'ArrowUp') rotateTetris();
        }
    });

    function startGame() {
        tg.MainButton.hide();
        document.getElementById('menu-box').style.display = 'none';
        document.getElementById('game-box').style.display = 'block';
        const cvs = document.getElementById('canvas');
        cvs.style.display = 'block';
        score = 0;
        if(currentGame == 'snake') { cvs.width = 300; cvs.height = 300; startSnake(); }
        else { cvs.width = 240; cvs.height = 480; startTetris(); }
    }

    function startSnake() {
        const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5};
        move = {x:1, y:0};
        loop = setInterval(() => {
            let h = {x: s[0].x + move.x, y: s[0].y + move.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=20 || s.some(p=>p.x==h.x && p.y==h.y)) return end();
            s.unshift(h);
            if(h.x==f.x && h.y==f.y) {
                score++; document.getElementById('score-val').innerText = "–°–ß–ï–¢: " + score;
                f = {x:Math.floor(Math.random()*19), y:Math.floor(Math.random()*19)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    function startTetris() {
        const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
        tBoard = Array(ROWS).fill().map(() => Array(COLS).fill(0));
        spawnPiece();
        loop = setInterval(() => { dropTetris(); drawTetris(ctx); }, 500);
    }

    function spawnPiece() {
        const p = [[[1,1,1,1]], [[1,1],[1,1]], [[0,1,0],[1,1,1]], [[1,1,0],[0,1,1]]];
        tPiece = p[Math.floor(Math.random()*p.length)];
        tPos = {x: 3, y: 0};
        if(collide()) return end();
    }

    function drawTetris(ctx) {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,240,480);
        tBoard.forEach((row, y) => row.forEach((v, x) => {
            if(v) { ctx.fillStyle = "#2481cc"; ctx.fillRect(x*BLOCK, y*BLOCK, BLOCK-1, BLOCK-1); }
        }));
        ctx.fillStyle = "#fff";
        tPiece.forEach((row, y) => row.forEach((v, x) => {
            if(v) ctx.fillRect((tPos.x + x)*BLOCK, (tPos.y + y)*BLOCK, BLOCK-1, BLOCK-1);
        }));
    }

    function dropTetris() {
        tPos.y++;
        if(collide()) { tPos.y--; merge(); spawnPiece(); clearLines(); }
    }

    function moveTetris(d) { tPos.x += d; if(collide()) tPos.x -= d; }
    function rotateTetris() {
        const next = tPiece[0].map((_, i) => tPiece.map(row => row[i]).reverse());
        const old = tPiece; tPiece = next;
        if(collide()) tPiece = old;
    }

    function collide() {
        return tPiece.some((row, y) => row.some((v, x) => {
            let nx = tPos.x + x, ny = tPos.y + y;
            return v && (nx < 0 || nx >= COLS || ny >= ROWS || (ny >= 0 && tBoard[ny][nx]));
        }));
    }

    function merge() { tPiece.forEach((row, y) => row.forEach((v, x) => { if(v) tBoard[tPos.y + y][tPos.x + x] = 1; })); }

    function clearLines() {
        tBoard = tBoard.filter(row => row.some(v => v == 0));
        while(tBoard.length < ROWS) {
            tBoard.unshift(Array(COLS).fill(0));
            score += 10; document.getElementById('score-val').innerText = "–°–ß–ï–¢: " + score;
        }
    }

    function end() {
        clearInterval(loop);
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('res-score').innerText = score;
        if (!isPractice && currentLobbyId) sendScore();
    }

    async function sendScore() {
        try {
            await fetch(`${API}/api/submit-score`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId, score: score }) });
        } catch(e) { console.error("Score Error"); }
    }

    async function buyStars() {
        const val = document.getElementById('pay-amount').value;
        const r = await fetch(`${API}/api/create-invoice`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, amount: parseInt(val) }) });
        const d = await r.json();
        if(d.invoiceLink) tg.openInvoice(d.invoiceLink, (s) => { if(s=='paid') loadUser(); });
    }

    loadUser(); checkInvite();
</script>
</body>
</html>
