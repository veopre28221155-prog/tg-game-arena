<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Battle Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: #111111;
            --tg-text: #ffffff;
            --tg-btn: #0044cc;
            --tg-btn-text: #ffffff;
            --tg-sec-bg: #222222;
            --accent-neon: #00f0ff; 
            --accent-pink: #ff0055; 
            --font-retro: 'Press Start 2P', cursive;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--tg-bg); color: var(--tg-text); font-family: var(--font-retro); height: 100vh; width: 100vw; overflow: hidden; position: relative; user-select: none; -webkit-user-select: none; touch-action: none; }
        
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 70px); flex-direction: column; align-items: center; overflow-y: auto; padding: 20px; padding-bottom: 50px; font-family: -apple-system, sans-serif; }
        .screen.active { display: flex; }
        
        h1, h2 { font-family: var(--font-retro); text-transform: uppercase; margin-bottom: 20px; text-align: center; }
        h1 { font-size: 1.4rem; color: var(--accent-neon); margin-top: 15px; line-height: 1.4; text-shadow: 0 0 5px var(--accent-neon); }
        
        .card { background: var(--tg-sec-bg); border-radius: 12px; padding: 16px; width: 100%; max-width: 350px; margin-bottom: 16px; border: 1px solid var(--accent-neon); box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); }
        .card-free { border-color: rgba(255, 255, 255, 0.2); box-shadow: none; }
        
        .btn { background: var(--tg-btn); color: var(--tg-btn-text); border: none; border-radius: 8px; padding: 14px; width: 100%; font-size: 0.8rem; font-weight: bold; font-family: var(--font-retro); text-transform: uppercase; cursor: pointer; margin-bottom: 10px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--tg-btn); color: var(--tg-btn); }
        .btn-danger { background: var(--accent-pink); color: white; border: none; }
        .btn-duel { background: linear-gradient(45deg, #ff0055, #ff8800); color: white; font-size: 1rem; padding: 18px; border: 2px solid #fff; animation: pulse 2s infinite; }
        .btn-crypto { background: #2AABEE; color: white; border: none; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.7rem; margin-bottom: 0; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        select, input { background: var(--tg-bg); color: var(--tg-text); border: 1px solid var(--tg-btn); padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; font-size: 1rem; font-family: -apple-system, sans-serif;}

        canvas { 
            border: 4px solid var(--tg-text); 
            border-radius: 4px; 
            background: #000; 
            width: 100% !important; 
            max-width: 350px; 
            height: auto !important; 
            margin-bottom: 5px; 
            flex-shrink: 0;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .controls { display: flex; width: 100%; max-width: 350px; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .dpad-side, .action-side { display: flex; gap: 10px; }
        .ctrl-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid var(--tg-text); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; touch-action: manipulation; }
        .ctrl-btn:active { background: var(--accent-neon); color: black; border-color: var(--accent-neon); }
        .btn-jump { border-radius: 50%; width: 70px; height: 70px; background: rgba(255,0,85,0.5); border-color: var(--accent-pink); }
        .btn-jump:active { background: var(--accent-pink); }

        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--tg-sec-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .tab { display: flex; flex-direction: column; align-items: center; color: var(--tg-text); opacity: 0.5; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; }
        .tab.active { opacity: 1; color: var(--accent-neon); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; align-items:center; justify-content:center; flex-direction:column; padding: 20px; }
        .admin-row { font-size: 0.7rem; border-bottom: 1px solid #444; padding: 5px; display: flex; justify-content: space-between; }
        #admin-panel { display: none; border: 2px solid gold; margin-top: 20px; }
    </style>
</head>
<body>

<div id="app">
    <!-- MENU SCREEN -->
    <div id="s-play" class="screen active">
        <h1>RETRO ARENA</h1>

        <div class="card">
            <h2 style="color: var(--accent-neon); font-size: 1.1rem;">Ranked Sprint 1v1</h2>
            <p style="font-size:0.7rem; text-align:center; opacity:0.8; font-family: var(--font-retro);">Race to the finish line!<br>First player wins the pot.</p>
            <select id="search-bet">
                <option value="10">Bet: 10 ‚≠êÔ∏è</option>
                <option value="50">Bet: 50 ‚≠êÔ∏è</option>
                <option value="100">Bet: 100 ‚≠êÔ∏è</option>
                <option value="500">Bet: 500 ‚≠êÔ∏è</option>
            </select>
            <button class="btn btn-duel" onclick="startMatchmaking()">üèÅ RACE NOW üèÅ</button>
        </div>

        <div class="card card-free">
            <h2 style="font-size: 1rem;">Story Mode (Sega)</h2>
            <p style="font-size:0.7rem; text-align:center; opacity:0.7; font-family: var(--font-retro); margin-top: 0;">FREE PLAY</p>
            <button class="btn btn-outline" onclick="launchGame('story')">üéÆ PLAY SOLO</button>
        </div>
    </div>

    <!-- SEARCH SCREEN -->
    <div id="s-search" class="screen" style="justify-content: center;">
        <h1 class="blink" style="color: #ff8800;">WAITING FOR OPPONENT...</h1>
        <p style="text-align: center; opacity: 0.7; margin-bottom: 30px;">Finding match</p>
        <button class="btn btn-danger" onclick="cancelMatchmaking()">CANCEL</button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="s-profile" class="screen">
        <h1>PROFILE</h1>
        <div class="card card-free" style="text-align: center;">
            <div style="font-size: 2.5rem; font-family: var(--font-retro); color: gold; text-shadow: 2px 2px 0 #000;">
                <span id="p-bal">0</span> ‚òÖ
            </div>
            <div style="opacity: 0.7; font-size: 0.8rem; margin-top: 10px; font-weight: bold;">VIRTUAL STARS</div>
        </div>

        <div class="card card-free">
            <h2 style="font-size: 1rem;">Deposit (Crypto)</h2>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-crypto" onclick="depositCrypto('USDT', 1, 100)">1 USDT (+100‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('TON', 1, 500)">1 TON (+500‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('NOT', 1000, 1000)">1000 NOT (+1000‚òÖ)</button>
            </div>
        </div>
        <button class="btn btn-danger" onclick="withdraw()">WITHDRAW FUNDS</button>
        
        <div id="admin-panel" class="card">
            <h2 style="color: gold; font-size: 1rem;">ADMIN PANEL</h2>
            <div class="admin-row" style="margin-bottom: 10px;">
                <span style="font-weight: bold;">Commission:</span> 
                <span id="adm-commission" style="color:var(--accent-neon); font-weight:bold;">0‚òÖ</span>
            </div>
            <button class="btn btn-sm" onclick="loadAdminData()">REFRESH</button>
        </div>
        <div style="height: 20px;"></div>
    </div>

    <!-- GAME SCREEN -->
    <div id="s-game" class="screen" style="padding-top: 10px; padding-bottom: 0;">
        <div style="width: 100%; max-width: 350px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <button class="btn btn-danger btn-sm" style="margin:0;" onclick="quitGame()">GIVE UP</button>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="controls">
            <div class="dpad-side">
                <div class="ctrl-btn" ontouchstart="press('left',true)" ontouchend="press('left',false)" onmousedown="press('left',true)" onmouseup="press('left',false)">‚óÄ</div>
                <div class="ctrl-btn" ontouchstart="press('right',true)" ontouchend="press('right',false)" onmousedown="press('right',true)" onmouseup="press('right',false)">‚ñ∂</div>
                <div class="ctrl-btn" ontouchstart="press('down',true)" ontouchend="press('down',false)" onmousedown="press('down',true)" onmouseup="press('down',false)">‚ñº</div>
            </div>
            <div class="action-side">
                <div class="ctrl-btn btn-jump" ontouchstart="press('jump',true)" ontouchend="press('jump',false)" onmousedown="press('jump',true)" onmouseup="press('jump',false)">A</div>
            </div>
        </div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="nav('play', this)"><div class="tab-icon">üéÆ</div><div>PLAY</div></div>
    <div class="tab" onclick="nav('profile', this)"><div class="tab-icon">üë§</div><div>PROFILE</div></div>
</div>

<!-- GAME OVER MODAL -->
<div id="modal-over" class="modal">
    <h1 id="end-title" style="color:red; font-size:2.5rem; text-align: center; margin-bottom: 10px;">FINISH</h1>
    <p id="end-msg" style="color:white; font-family: var(--font-retro); font-size: 1rem; text-align: center; line-height: 1.5; margin-bottom: 30px;"></p>
    <button class="btn btn-outline" style="width:240px;" onclick="location.reload()">RETURN TO MENU</button>
</div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ê –ö–ê–ù–í–ê–°–ê –î–õ–Ø –ü–ò–ö–°–ï–õ–¨ –ê–†–¢–ê ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.style.imageRendering = 'pixelated';
    ctx.imageSmoothingEnabled = false;

    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ Sega Genesis
    canvas.width = 320; 
    canvas.height = 224; 

    const API = "https://tg-game-arena.onrender.com";
    const ADMIN_ID = 1463465416;
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
    
    let user = null, lobby = null, poll = null, loop = null, gameMode = '';

    // --- –ó–ê–ì–†–£–ó–ö–ê –í–ù–ï–®–ù–ï–ì–û –°–ü–†–ê–ô–¢-–õ–ò–°–¢–ê –°–û–ù–ò–ö–ê ---
    const sonicSprite = new Image();
    sonicSprite.crossOrigin = "Anonymous";
    sonicSprite.src = "https://info.sonicretro.org/images/1/1a/Sonic1_sheet.png";

    // –ê–Ω–∏–º–∞—Ü–∏–∏ –°–æ–Ω–∏–∫–∞
    const anims = {
        idle: Array.of({x: 18, y: 22, w: 29, h: 39}),
        run: Array.of(
            {x: 17, y: 104, w: 32, h: 39}, 
            {x: 56, y: 104, w: 32, h: 39}, 
            {x: 96, y: 104, w: 32, h: 39}, 
            {x: 133, y: 104, w: 32, h: 39}
        ),
        roll: Array.of(
            {x: 17, y: 201, w: 30, h: 29}, 
            {x: 52, y: 201, w: 30, h: 29}, 
            {x: 87, y: 201, w: 30, h: 29}, 
            {x: 122, y: 201, w: 30, h: 29}
        )
    };

    // --- –§–ò–ó–ò–ö–ê –ò –î–í–ò–ñ–û–ö –ü–õ–ê–¢–§–û–†–ú–ï–†–ê ---
    const TILE_SIZE = 32;
    const MAP_W = 60;
    const MAP_H = 15;
    let mapData = Array.from({length: MAP_W * MAP_H}, () => 0); // 0 = –ø—É—Å—Ç–æ, 1 = –∑–µ–º–ª—è, 2 = —Ñ–∏–Ω–∏—à

    const GRAVITY = 0.21875;
    const ACCEL = 0.046875;
    const FRICTION = 0.046875;
    const MAX_SPEED = 6;
    const JUMP_FORCE = 6.5;

    let player = {
        x: 50, y: 50, vx: 0, vy: 0,
        width: 20, height: 30,
        state: 'idle', 
        frame: 0, frameTimer: 0,
        dir: 1, 
        grounded: false
    };

    const keys = { left: false, right: false, up: false, down: false, jump: false };

    window.press = function(k, state) { Reflect.set(keys, k, state); };

    function buildLevel() {
        mapData = Array.from({length: MAP_W * MAP_H}, () => 0);
        
        // –ü–æ–ª
        for(let x = 0; x < MAP_W; x++) {
            Reflect.set(mapData, 13 * MAP_W + x, 1);
            Reflect.set(mapData, 14 * MAP_W + x, 1);
        }
        
        // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ —è–º—ã
        for(let x = 20; x < 25; x++) {
            Reflect.set(mapData, 13 * MAP_W + x, 0);
            Reflect.set(mapData, 14 * MAP_W + x, 0);
        }

        // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
        Reflect.set(mapData, 10 * MAP_W + 10, 1);
        Reflect.set(mapData, 10 * MAP_W + 11, 1);
        Reflect.set(mapData, 10 * MAP_W + 12, 1);

        Reflect.set(mapData, 9 * MAP_W + 30, 1);
        Reflect.set(mapData, 9 * MAP_W + 31, 1);

        // –§–∏–Ω–∏—à–Ω–∞—è —á–µ—Ä—Ç–∞
        Reflect.set(mapData, 12 * MAP_W + (MAP_W - 5), 2);
        Reflect.set(mapData, 11 * MAP_W + (MAP_W - 5), 2);
    }

    function getTile(x, y) {
        if (x < 0 || x >= MAP_W || y < 0 || y >= MAP_H) return 1;
        return mapData.at(y * MAP_W + x);
    }

    function updatePhysics() {
        if (keys.left) {
            player.dir = -1;
            if (player.vx > -MAX_SPEED) player.vx -= ACCEL;
            player.state = 'run';
        } else if (keys.right) {
            player.dir = 1;
            if (player.vx < MAX_SPEED) player.vx += ACCEL;
            player.state = 'run';
        } else {
            if (player.vx > 0) {
                player.vx -= FRICTION;
                if (player.vx < 0) player.vx = 0;
            } else if (player.vx < 0) {
                player.vx += FRICTION;
                if (player.vx > 0) player.vx = 0;
            }
            player.state = 'idle';
        }

        if (keys.down && Math.abs(player.vx) > 1) {
            player.state = 'roll';
        }

        if (keys.jump && player.grounded) {
            player.vy = -JUMP_FORCE;
            player.grounded = false;
            player.state = 'roll';
            keys.jump = false;
        } else if (!player.grounded) {
            player.state = 'roll';
        }

        player.vy += GRAVITY;

        // –ö–æ–ª–ª–∏–∑–∏–∏ X
        player.x += player.vx;
        let tx1 = Math.floor(player.x / TILE_SIZE);
        let tx2 = Math.floor((player.x + player.width) / TILE_SIZE);
        let ty1 = Math.floor(player.y / TILE_SIZE);
        let ty2 = Math.floor((player.y + player.height - 1) / TILE_SIZE);

        if (player.vx > 0) {
            if (getTile(tx2, ty1) === 1 || getTile(tx2, ty2) === 1) {
                player.x = tx2 * TILE_SIZE - player.width - 0.1;
                player.vx = 0;
            }
        } else if (player.vx < 0) {
            if (getTile(tx1, ty1) === 1 || getTile(tx1, ty2) === 1) {
                player.x = (tx1 + 1) * TILE_SIZE + 0.1;
                player.vx = 0;
            }
        }

        // –ö–æ–ª–ª–∏–∑–∏–∏ Y
        player.y += player.vy;
        tx1 = Math.floor((player.x + 2) / TILE_SIZE); 
        tx2 = Math.floor((player.x + player.width - 2) / TILE_SIZE);
        ty1 = Math.floor(player.y / TILE_SIZE);
        ty2 = Math.floor((player.y + player.height) / TILE_SIZE);

        player.grounded = false;
        if (player.vy > 0) { 
            if (getTile(tx1, ty2) === 1 || getTile(tx2, ty2) === 1) {
                player.y = ty2 * TILE_SIZE - player.height;
                player.vy = 0;
                player.grounded = true;
            }
        } else if (player.vy < 0) { 
            if (getTile(tx1, ty1) === 1 || getTile(tx2, ty1) === 1) {
                player.y = (ty1 + 1) * TILE_SIZE;
                player.vy = 0;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∏—à–∞
        let centerTx = Math.floor((player.x + player.width / 2) / TILE_SIZE);
        let centerTy = Math.floor((player.y + player.height / 2) / TILE_SIZE);
        if (getTile(centerTx, centerTy) === 2) {
            triggerFinish();
        }

        // –ü–∞–¥–µ–Ω–∏–µ –≤ —è–º—É
        if (player.y > MAP_H * TILE_SIZE) {
            player.x = 50; player.y = 50; player.vx = 0; player.vy = 0; 
        }
    }

    function updateAnimation() {
        player.frameTimer++;
        let speed = 10;
        if (player.state === 'run') speed = Math.max(2, 10 - Math.abs(player.vx));
        if (player.state === 'roll') speed = 4;

        if (player.frameTimer > speed) {
            player.frameTimer = 0;
            player.frame++;
        }

        let currentAnimArray = Reflect.get(anims, player.state) || anims.idle;
        if (player.frame >= currentAnimArray.length) player.frame = 0;
    }

    let cameraX = 0;
    function drawGame() {
        ctx.fillStyle = '#2452FF'; // –ù–µ–±–æ
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        cameraX = player.x - canvas.width / 2;
        if (cameraX < 0) cameraX = 0;
        if (cameraX > MAP_W * TILE_SIZE - canvas.width) cameraX = MAP_W * TILE_SIZE - canvas.width;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–π–ª–æ–≤
        for (let y = 0; y < MAP_H; y++) {
            for (let x = 0; x < MAP_W; x++) {
                let tile = getTile(x, y);
                let drawX = Math.floor(x * TILE_SIZE - cameraX);
                let drawY = Math.floor(y * TILE_SIZE);

                if (drawX < -TILE_SIZE || drawX > canvas.width) continue;

                if (tile === 1) {
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(drawX, drawY, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(drawX, drawY, TILE_SIZE, 8);
                } else if (tile === 2) {
                    ctx.fillStyle = '#FFD700'; // –§–∏–Ω–∏—à–Ω–∞—è —Ç–∞–±–ª–∏—á–∫–∞
                    ctx.fillRect(drawX + 10, drawY, 12, TILE_SIZE);
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –°–æ–Ω–∏–∫–∞
        let currentAnimArray = Reflect.get(anims, player.state) || anims.idle;
        let frm = currentAnimArray.at(player.frame % currentAnimArray.length);

        ctx.save();
        ctx.translate(Math.floor(player.x - cameraX + player.width / 2), Math.floor(player.y + player.height / 2));
        if (player.dir === -1) ctx.scale(-1, 1);

        if (sonicSprite.complete && sonicSprite.naturalWidth !== 0) {
            ctx.drawImage(sonicSprite, frm.x, frm.y, frm.w, frm.h, -frm.w/2, -frm.h/2 + 4, frm.w, frm.h);
        } else {
            ctx.fillStyle = '#0020B0';
            ctx.fillRect(-player.width/2, -player.height/2, player.width, player.height);
        }
        ctx.restore();
    }

    function gameTick() {
        if (!loop) return;
        updatePhysics();
        updateAnimation();
        drawGame();
        loop = requestAnimationFrame(gameTick);
    }

    // --- –°–ï–¢–ï–í–ê–Ø –ò–ì–†–ê –ò UI ---
    async function init() {
        const r = await fetch(API + '/api/user-data', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
        user = await r.json(); 
        document.getElementById('p-bal').innerText = user.balance;
        if (user.telegramId === ADMIN_ID) document.getElementById('admin-panel').style.display = 'block';
    }
    init();

    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('s-' + id).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    async function startMatchmaking() {
        const b = parseInt(document.getElementById('search-bet').value);
        if (user.balance < b) return tg.showAlert('Insufficient balance');
        nav('search');
        const r = await fetch(API + '/api/search-match', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, gameType: 'sonicSprint', betAmount: b }) });
        const d = await r.json();
        if (d.status === 'match_found') { lobby = { lobbyId: d.lobbyId, betAmount: b }; launchGame('ranked'); }
        else { 
            poll = setInterval(async () => {
                const cr = await fetch(API + '/api/check-match-status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId }) });
                const cd = await cr.json(); 
                if (cd.status === 'match_found') { clearInterval(poll); lobby = cd.lobby; launchGame('ranked'); }
            }, 3000); 
        }
    }

    async function cancelMatchmaking() {
        clearInterval(poll);
        await fetch(API + '/api/cancel-match', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId }) });
        location.reload();
    }

    function launchGame(mode) {
        gameMode = mode;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('s-game').classList.add('active');
        document.querySelector('.tabs').style.display = 'none';
        
        player.x = 50; player.y = 50; player.vx = 0; player.vy = 0;
        buildLevel();
        
        if(loop) cancelAnimationFrame(loop);
        loop = requestAnimationFrame(gameTick);
    }

    async function triggerFinish() {
        if (loop) cancelAnimationFrame(loop);
        loop = null;
        
        document.getElementById('modal-over').style.display = 'flex';
        
        if (lobby && gameMode === 'ranked') {
            document.getElementById('end-title').innerText = 'FINISH!';
            document.getElementById('end-title').style.color = '#ff8800';
            document.getElementById('end-msg').innerText = 'Validating result with server...';
            
            const r = await fetch(API + '/api/submit-score', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ telegramId: user.telegramId, finished: true, lobbyId: lobby.lobbyId }) 
            });
            const d = await r.json();
            
            if (d.isWinner) {
                document.getElementById('end-title').innerText = 'YOU WIN!';
                document.getElementById('end-title').style.color = '#00f0ff';
                document.getElementById('end-msg').innerText = 'Prize credited to your balance!';
            } else {
                document.getElementById('end-title').innerText = 'DEFEAT';
                document.getElementById('end-title').style.color = '#ff0055';
                document.getElementById('end-msg').innerText = 'Opponent reached the finish line first.';
            }
        } else {
            document.getElementById('end-title').innerText = 'LEVEL CLEARED';
            document.getElementById('end-title').style.color = '#00f0ff';
            document.getElementById('end-msg').innerText = 'You completed the track!';
        }
    }

    function quitGame() {
        tg.showConfirm('Forfeit the match?', async function(confirmed) {
            if(!confirmed) return;
            if (lobby) {
                await fetch(API + '/api/forfeit', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, lobbyId: lobby.lobbyId }) });
            }
            location.reload();
        });
    }

    async function depositCrypto(asset, cryptoAmount, starsAmount) {
        const r = await fetch(API + '/api/deposit', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, asset, amount: cryptoAmount, stars: starsAmount }) });
        const d = await r.json();
        if (d.payUrl) {
            tg.openTelegramLink(d.payUrl);
            let checkingTimer = setInterval(async () => {
                const cur = await fetch(API + '/api/user-data', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
                const curUser = await cur.json();
                if(curUser.balance > user.balance) {
                    user.balance = curUser.balance;
                    document.getElementById('p-bal').innerText = user.balance;
                    clearInterval(checkingTimer);
                    tg.showAlert('Balance updated!');
                }
            }, 3000);
            setTimeout(() => clearInterval(checkingTimer), 300000);
        } else { tg.showAlert('Invoice error'); }
    }

    function withdraw() {
        if(user.balance <= 0) return tg.showAlert('Empty balance');
        tg.showConfirm('Withdraw ' + user.balance + ' Stars?', async function(confirmed) {
            if(!confirmed) return;
            const r = await fetch(API + '/api/withdraw', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, amount: user.balance }) });
            const d = await r.json();
            if (d.success) { 
                user.balance = d.newBalance; 
                document.getElementById('p-bal').innerText = user.balance; 
                tg.showAlert('Request sent!'); 
            } else tg.showAlert(d.error);
        });
    }

    async function loadAdminData() {
        const r = await fetch(API + '/api/admin/data', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ adminId: user.telegramId }) });
        const d = await r.json();
        document.getElementById('adm-commission').innerText = (d.adminCommission || 0) + '‚òÖ';
    }
</script>
</body>
</html>
