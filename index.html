<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #f0f0f2);
            --text: var(--tg-theme-text-color, #000000);
        }
        body { background: var(--sec-bg); color: var(--text); margin: 0; font-family: -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }

        .card { background: var(--sec-bg); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; box-sizing: border-box; text-align: center; }
        .btn { background: var(--btn); color: var(--btn-text); border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        .btn:disabled { opacity: 0.5; cursor: default; }
        
        #game-canvas { background: #000; border-radius: 8px; display: none; }
        #countdown { font-size: 80px; font-weight: bold; color: var(--btn); display: none; margin: 20px; }

        #nav { display: flex; background: var(--bg); height: 65px; border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: var(--hint); cursor: pointer; }
        .nav-item.active { color: var(--btn); }

        .game-controls { display: none; grid-template-columns: repeat(3, 65px); gap: 10px; margin-top: 15px; }
        .ctrl-btn { width: 65px; height: 65px; background: var(--sec-bg); border-radius: 50%; border: none; font-size: 24px; }
    </style>
</head>
<body>

<div id="app">
    <div id="arena" class="screen active">
        <div class="card">
            <h3>–í—ã–±–æ—Ä –∏–≥—Ä—ã</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="sel-snake" onclick="selectGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
                <button class="btn" style="background:#888" id="sel-tetris" onclick="selectGame('tetris')">üß± –¢–µ—Ç—Ä–∏—Å</button>
            </div>
        </div>
        
        <div id="lobby-card" class="card">
            <h4 id="lobby-title">–†–µ–∂–∏–º: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h4>
            <button class="btn" onclick="startLobby()">üî• –ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ</button>
            <button class="btn" style="background:none; color:var(--btn); border:1px solid var(--btn)" onclick="inviteFriend()">‚öîÔ∏è –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
        </div>

        <div id="game-zone" style="display:none; flex-direction:column; align-items:center; width:100%;">
            <div id="countdown">3</div>
            <div id="score" style="font-size: 20px; font-weight:bold; margin-bottom:5px;">Score: 0</div>
            <canvas id="gameCanvas" width="300" height="300"></canvas>
            
            <div id="controls" class="game-controls">
                <div></div><button class="ctrl-btn" onclick="setDir(0,-1)">‚Üë</button><div></div>
                <button class="ctrl-btn" onclick="setDir(-1,0)">‚Üê</button>
                <button class="ctrl-btn" onclick="setDir(0,1)">‚Üì</button>
                <button class="ctrl-btn" onclick="setDir(1,0)">‚Üí</button>
            </div>
            <button class="btn" style="background:red; width:120px; margin-top:15px;" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="search" class="screen">
        <div class="card">
            <h3>–†–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ–∏—Å–∫</h3>
            <p style="color:var(--hint)">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–≤–∫—É:</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ –Ω–∞ 10 ‚≠ê –Ω–∞—á–∞—Ç')">10 ‚≠ê</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ –Ω–∞ 50 ‚≠ê –Ω–∞—á–∞—Ç')">50 ‚≠ê</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ –Ω–∞ 100 ‚≠ê –Ω–∞—á–∞—Ç')">100 ‚≠ê</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ –Ω–∞ 500 ‚≠ê –Ω–∞—á–∞—Ç')">500 ‚≠ê</button>
            </div>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">–ò–≥—Ä–æ–∫</h2>
            <div style="font-size: 36px; font-weight: 800; color: var(--btn)">‚≠ê <span id="u-balance">0</span></div>
        </div>
        
        <div class="card">
            <h4>–û–ø–µ—Ä–∞—Ü–∏–∏</h4>
            <input type="number" id="stars-amt" value="50" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            <button class="btn" onclick="pay()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn" style="background:#ff3b30" onclick="withdraw()">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)"><span>üéÆ</span>–ê—Ä–µ–Ω–∞</div>
        <div class="nav-item" onclick="tab('search', this)"><span>üîç</span>–ü–æ–∏—Å–∫</div>
        <div class="nav-item" onclick="tab('profile', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', snakeDir = {x:1, y:0};

    tg.expand();

    async function load() {
        const r = await fetch(`${API}/api/user-data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData })
        });
        const d = await r.json();
        balance = d.balance;
        document.getElementById('u-balance').innerText = balance;
        document.getElementById('u-name').innerText = d.name;
    }

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function selectGame(g) {
        currentGame = g;
        document.getElementById('sel-snake').style.opacity = g === 'snake' ? '1' : '0.5';
        document.getElementById('sel-tetris').style.opacity = g === 'tetris' ? '1' : '0.5';
    }

    function startLobby() {
        document.getElementById('lobby-card').style.display = 'none';
        document.getElementById('game-zone').style.display = 'flex';
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        let count = 3;
        const timer = setInterval(() => {
            cd.innerText = count;
            count--;
            if(count < 0) {
                clearInterval(timer);
                cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('controls').style.display = 'grid';
                if(currentGame === 'snake') runSnake(); else runTetris();
            }
        }, 1000);
    }

    function setDir(x, y) { snakeDir = {x, y}; }

    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let snake = [{x:10, y:10}], food = {x:5, y:5}, score = 0;
        setInterval(() => {
            let head = {x: snake[0].x + snakeDir.x, y: snake[0].y + snakeDir.y};
            if(head.x<0||head.x>=20||head.y<0||head.y>=20) return location.reload();
            snake.unshift(head);
            if(head.x===food.x && head.y===food.y) {
                score++;
                document.getElementById('score').innerText = "Score: " + score;
                food = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*20)};
            } else { snake.pop(); }
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = "#2481cc"; snake.forEach(s=>ctx.fillRect(s.x*15, s.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(food.x*15, food.y*15, 14, 14);
        }, 150);
    }

    function inviteFriend() {
        tg.switchInlineQuery("play_with_me", ["users", "chats"]);
    }

    async function withdraw() {
        const amt = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞ Stars:");
        if(!amt || amt < 50) return tg.showAlert("–ú–∏–Ω–∏–º—É–º 50 Stars!");
        const r = await fetch(`${API}/api/withdraw`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(amt) })
        });
        const d = await r.json();
        if(d.success) {
            tg.showAlert("–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Å–æ–∑–¥–∞–Ω–∞!");
            load();
        }
    }

    async function pay() {
        const amt = document.getElementById('stars-amt').value;
        const r = await fetch(`${API}/api/create-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(amt) })
        });
        const d = await r.json();
        if(d.invoiceLink) tg.openInvoice(d.invoiceLink, (s) => { if(s==='paid') load(); });
    }

    load();
</script>
</body>
</html>
