<!DOCTYPE html><html lang="ru"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #fff; --btn: #2481cc; --sec: #f0f0f2; --text: #000; }
        body { background: var(--sec); color: var(--text); margin: 0; font-family: sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }
        .card { background: var(--sec); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; text-align: center; box-sizing: border-box; }
        .btn { background: var(--btn); color: #fff; border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        canvas { background: #000; border-radius: 8px; display: none; }
        #nav { display: flex; background: var(--bg); height: 60px; border-top: 1px solid #ddd; }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #999; }
        .nav-item.active { color: var(--btn); font-weight: bold; }
        #result-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #fff; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style></head><body><div id="app">
    
    <div id="result-overlay">
        <h2>–ú–∞—Ç—á –æ–∫–æ–Ω—á–µ–Ω</h2>
        <p id="res-score">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Ç–æ–≥–æ–≤...</p>
        <button class="btn" onclick="preStart(isPractice)">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        <button class="btn" style="background:#444" onclick="location.reload()">–í –º–µ–Ω—é</button>
    </div>

    <div id="arena" class="screen active">
        <div class="card">
            <h3>–ò–≥—Ä—ã</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="s-snake" onclick="setGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
                <button class="btn" style="opacity:0.5" id="s-tetris" onclick="setGame('tetris')">üß± –¢–µ—Ç—Ä–∏—Å</button>
            </div>
        </div>
        <div id="arena-menu" class="card">
            <h4 id="mode-info">–í—ã–±—Ä–∞–Ω–æ: –ó–º–µ–π–∫–∞</h4>
            <button class="btn" onclick="preStart(true)">üî• –¢–†–ï–ù–ò–†–û–í–ö–ê</button>
            <button class="btn" style="background:none; color:var(--btn); border:1px solid var(--btn)" id="friend-btn">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –° –î–†–£–ì–û–ú</button>
        </div>
        <div id="game-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
            <div id="countdown" style="font-size:40px; font-weight:bold; margin:20px; color:var(--btn)">3</div>
            <div id="score-text" style="font-weight:bold;">Score: 0</div>
            <canvas id="gameCanvas" width="300" height="400"></canvas>
            <button class="btn" style="background:red; width:100px" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">Player</h2>
            <div style="font-size:32px; font-weight:bold; color:var(--btn)">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <button class="btn" onclick="pay()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)">–ê–†–ï–ù–ê</div>
        <div class="nav-item" onclick="tab('profile', this)">–ü–†–û–§–ò–õ–¨</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', moveDir = {x:1, y:0}, isPractice = true;
    let gameLoop, currentLobbyId = null, currentScore = 0;

    tg.expand();
    tg.ready();

    // –ñ–ï–õ–ï–ó–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp') handleInput('up');
        if (e.key === 'ArrowDown') handleInput('down');
        if (e.key === 'ArrowLeft') handleInput('left');
        if (e.key === 'ArrowRight') handleInput('right');
    });

    function handleInput(dir) {
        if (currentGame === 'snake') {
            if (dir === 'up' && moveDir.y === 0) moveDir = {x:0, y:-1};
            if (dir === 'down' && moveDir.y === 0) moveDir = {x:0, y:1};
            if (dir === 'left' && moveDir.x === 0) moveDir = {x:-1, y:0};
            if (dir === 'right' && moveDir.x === 0) moveDir = {x:1, y:0};
        }
    }

    async function load() {
        const r = await fetch(`${API}/api/user-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
        const d = await r.json();
        document.getElementById('u-balance').innerText = d.balance;
        document.getElementById('u-name').innerText = d.name;
    }

    // –ö–ù–û–ü–ö–ê –î–†–£–ì–ê
    document.getElementById('friend-btn').addEventListener('click', () => {
        const lobbyId = Math.random().toString(36).substr(2, 9);
        tg.switchInlineQuery(`lobby_${lobbyId}`, ['users', 'chats']);
    });

    async function checkInvite() {
        const startParam = tg.initDataUnsafe.start_param;
        if (startParam && startParam.startsWith('lobby_')) {
            currentLobbyId = startParam.replace('lobby_', '');
            isPractice = false;
            await fetch(`${API}/api/join-lobby`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId }) });
            preStart(false);
        }
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('s-snake').style.opacity = g === 'snake' ? '1' : '0.5';
        document.getElementById('s-tetris').style.opacity = g === 'tetris' ? '1' : '0.5';
    }

    function preStart(practice) {
        isPractice = practice;
        document.getElementById('arena-menu').style.display = 'none';
        document.getElementById('result-overlay').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        let c = 3;
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        const t = setInterval(() => {
            cd.innerText = c;
            c--;
            if(c < 0) {
                clearInterval(t);
                cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                runSnake();
            }
        }, 1000);
    }

    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5};
        currentScore = 0;
        moveDir = {x:1, y:0};
        gameLoop = setInterval(() => {
            let h = {x: s[0].x + moveDir.x, y: s[0].y + moveDir.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=26) { stopGame(); return; }
            s.unshift(h);
            if(h.x===f.x && h.y===f.y) {
                currentScore++;
                document.getElementById('score-text').innerText = "Score: " + currentScore;
                f = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*20)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,400);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    function stopGame() {
        clearInterval(gameLoop);
        if(!isPractice) submitScore();
        else tg.showAlert("–§–∏–Ω–∏—à! –°—á–µ—Ç: " + currentScore);
    }

    async function submitScore() {
        const r = await fetch(`${API}/api/submit-score`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId, score: currentScore }) });
        const l = await r.json();
        document.getElementById('result-overlay').style.display = 'flex';
        document.getElementById('res-score').innerText = "–¢–≤–æ–π —Å—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ª–æ–±–±–∏!";
    }

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    load(); checkInvite();
</script></body></html>
