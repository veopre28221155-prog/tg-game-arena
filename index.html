<script>
    const tg = window.Telegram.WebApp;
    // Принудительно сообщаем Telegram, что приложение готово
    tg.ready();
    tg.expand();

    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', moveDir = {x:1, y:0}, isPractice = true;
    let gameLoop, currentLobbyId = null, currentScore = 0;

    // --- ЛОГИКА ИНТЕРФЕЙСА (ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК) ---
    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('s-snake').style.opacity = g === 'snake' ? '1' : '0.5';
        document.getElementById('s-tetris').style.opacity = g === 'tetris' ? '1' : '0.5';
        document.getElementById('mode-info').innerText = "Выбрано: " + (g === 'snake' ? 'Змейка' : 'Тетрис');
    }

    // --- ОТЛАДОЧНАЯ ФУНКЦИЯ "ИГРАТЬ С ДРУГОМ" ---
    function shareLobby() {
        console.log("Кнопка нажата, начинаем вызов...");
        try {
            const lobbyId = Math.random().toString(36).substr(2, 9);
            currentLobbyId = lobbyId;
            
            // Проверяем, видит ли скрипт объект Telegram
            if (!window.Telegram || !window.Telegram.WebApp) {
                alert("Ошибка: Telegram SDK не загружен!");
                return;
            }

            // Если это сработает, значит JS код выполняется верно
            alert("Вызываем меню выбора чата для лобби: " + lobbyId);
            
            // Вызов API Telegram
            if (tg.isVersionAtLeast('6.7')) {
                tg.switchInlineQuery(`lobby_${lobbyId}`, ['users', 'chats', 'groups']);
            } else {
                tg.switchInlineQuery(`lobby_${lobbyId}`);
            }
            
        } catch (e) {
            alert("Критическая ошибка скрипта: " + e.message);
        }
    }

    // Привязываем функцию к кнопке после загрузки страницы
    document.addEventListener('DOMContentLoaded', () => {
        const friendBtn = document.getElementById('friend-btn');
        if (friendBtn) {
            friendBtn.onclick = shareLobby;
        }
    });

    // --- ПОПОЛНЕНИЕ STARS ---
    async function pay() {
        const amt = document.getElementById('pay-amt').value;
        try {
            const r = await fetch(`${API}/api/create-invoice`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ initData: tg.initData, amount: parseInt(amt) }) 
            });
            const d = await r.json();
            if(d.invoiceLink) {
                tg.openInvoice(d.invoiceLink, (status) => {
                    if(status === 'paid') load();
                });
            }
        } catch(e) { 
            alert("Ошибка при создании счета"); 
        }
    }

    // --- УПРАВЛЕНИЕ КЛАВИАТУРОЙ (ПК) ---
    window.addEventListener('keydown', (e) => {
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        if (currentGame === 'snake') {
            if (e.key === 'ArrowUp' && moveDir.y === 0) moveDir = {x:0, y:-1};
            if (e.key === 'ArrowDown' && moveDir.y === 0) moveDir = {x:0, y:1};
            if (e.key === 'ArrowLeft' && moveDir.x === 0) moveDir = {x:-1, y:0};
            if (e.key === 'ArrowRight' && moveDir.x === 0) moveDir = {x:1, y:0};
        } else if (currentGame === 'tetris') {
            if (e.key === 'ArrowLeft') tetrisMove(-1);
            if (e.key === 'ArrowRight') tetrisMove(1);
            if (e.key === 'ArrowDown') tetrisDrop();
            if (e.key === 'ArrowUp') tetrisRotate();
        }
    });

    // --- ЗАПУСК ИГРЫ ---
    function preStart(practice) {
        isPractice = practice;
        document.getElementById('arena-menu').style.display = 'none';
        document.getElementById('result-overlay').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        let c = 3;
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        const t = setInterval(() => {
            cd.innerText = c; c--;
            if(c < 0) {
                clearInterval(t); cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                if(currentGame === 'snake') runSnake(); else runTetris();
            }
        }, 1000);
    }

    // --- ДВИЖОК: ЗМЕЙКА ---
    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5};
        currentScore = 0; moveDir = {x:1, y:0};
        gameLoop = setInterval(() => {
            let h = {x: s[0].x + moveDir.x, y: s[0].y + moveDir.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=30) { stopGame(); return; }
            s.unshift(h);
            if(h.x===f.x && h.y===f.y) {
                currentScore++; document.getElementById('score-text').innerText = "Score: " + currentScore;
                f = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*30)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,450);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    // --- ДВИЖОК: ТЕТРИС ---
    let tBoard, tPiece;
    function runTetris() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        tBoard = Array(20).fill().map(() => Array(10).fill(0));
        currentScore = 0; spawnTPiece();
        gameLoop = setInterval(() => { tetrisDrop(); drawTetris(ctx); }, 600);
    }
    function spawnTPiece() {
        const pieces = 'IJOSTZL';
        const t = pieces[Math.random() * pieces.length | 0];
        tPiece = { pos: {x:3, y:0}, matrix: createTPiece(t) };
        if (tCollide()) stopGame();
    }
    function createTPiece(t) {
        if(t==='I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
        if(t==='T') return [[0,1,0],[1,1,1],[0,0,0]];
        if(t==='O') return [[1,1],[1,1]];
        if(t==='L') return [[0,1,0],[0,1,0],[0,1,1]];
        if(t==='J') return [[0,1,0],[0,1,0],[1,1,0]];
        return [[1,1,0],[0,1,1],[0,0,0]];
    }
    function tetrisDrop() {
        tPiece.pos.y++;
        if(tCollide()){ tPiece.pos.y--; tMerge(); spawnTPiece(); tClear(); }
    }
    function tCollide() {
        const [m, o] = [tPiece.matrix, tPiece.pos];
        for(let y=0; y<m.length; y++) for(let x=0; x<m[y].length; x++)
            if(m[y][x] && (tBoard[y+o.y] && tBoard[y+o.y][x+o.x]) !== 0) return true;
        return false;
    }
    function tMerge() { tPiece.matrix.forEach((r,y)=>r.forEach((v,x)=>{ if(v) tBoard[y+tPiece.pos.y][x+tPiece.pos.x]=1; })); }
    function tClear() {
        outer: for(let y=tBoard.length-1; y>0; y--) {
            for(let x=0; x<tBoard[y].length; x++) if(!tBoard[y][x]) continue outer;
            tBoard.splice(y,1); tBoard.unshift(Array(10).fill(0));
            currentScore += 10; document.getElementById('score-text').innerText = "Score: "+currentScore;
            y++;
        }
    }
    function drawTetris(ctx) {
        ctx.fillStyle='#000'; ctx.fillRect(0,0,300,450);
        tBoard.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle='#2481cc'; ctx.fillRect(x*30, y*22.5, 29, 21.5); } }));
        tPiece.matrix.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle='#fff'; ctx.fillRect((x+tPiece.pos.x)*30, (y+tPiece.pos.y)*22.5, 29, 21.5); } }));
    }
    function tetrisMove(d){ tPiece.pos.x += d; if(tCollide()) tPiece.pos.x -= d; }
    function tetrisRotate(){ 
        const old=tPiece.matrix; 
        tPiece.matrix = tPiece.matrix[0].map((_,i)=>tPiece.matrix.map(r=>r[i]).reverse());
        if(tCollide()) tPiece.matrix = old;
    }

    // --- ОСТАНОВКА И ОТПРАВКА ОЧКОВ ---
    function stopGame() {
        clearInterval(gameLoop);
        if(!isPractice) submitScore(); else tg.showAlert("Счет: " + currentScore);
    }

    async function submitScore() {
        try {
            await fetch(`${API}/api/submit-score`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId, score: currentScore }) 
            });
            document.getElementById('result-overlay').style.display = 'flex';
            document.getElementById('res-score').innerText = "Результат дуэли: " + currentScore;
        } catch(e) { 
            tg.showAlert("Ошибка отправки счета"); 
        }
    }

    // --- ЗАГРУЗКА ДАННЫХ И ПРОВЕРКА ВХОДА ---
    async function load() {
        try {
            const r = await fetch(`${API}/api/user-data`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ initData: tg.initData }) 
            });
            const d = await r.json();
            document.getElementById('u-balance').innerText = d.balance;
            document.getElementById('u-name').innerText = d.name;
        } catch(e) { console.error("Ошибка загрузки профиля"); }
    }

    async function checkInvite() {
        const sp = tg.initDataUnsafe.start_param;
        if (sp && sp.startsWith('lobby_')) {
            currentLobbyId = sp.replace('lobby_', '');
            isPractice = false;
            
            try {
                await fetch(`${API}/api/join-lobby`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId }) 
                });
                
                document.getElementById('mode-info').innerHTML = 
                    `<b style="color:red">⚔️ ДУЭЛЬ АКТИВНА</b>`;
                tg.showAlert("Вы вступили в дуэль!");
            } catch(e) { console.error("Ошибка входа в лобби"); }
        }
    }

    // Точка входа
    load(); 
    checkInvite();
</script>
