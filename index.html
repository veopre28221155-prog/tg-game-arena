<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #f0f0f2);
            --text: var(--tg-theme-text-color, #000000);
        }
        body { background: var(--sec-bg); color: var(--text); margin: 0; font-family: -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }
        .card { background: var(--sec-bg); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; box-sizing: border-box; text-align: center; }
        .btn { background: var(--btn); color: var(--btn-text); border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        canvas { background: #000; border-radius: 8px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #countdown { font-size: 80px; font-weight: bold; color: var(--btn); display: none; margin: 40px; }
        .controls { display: none; grid-template-columns: repeat(3, 70px); gap: 10px; margin-top: 15px; }
        .ctrl-btn { width: 70px; height: 70px; background: var(--sec-bg); border-radius: 50%; border: 1px solid #ddd; font-size: 24px; color: var(--text); display: flex; align-items: center; justify-content: center; }
        #nav { display: flex; background: var(--bg); height: 65px; border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: var(--hint); cursor: pointer; }
        .nav-item.active { color: var(--btn); }
    </style>
</head>
<body>
<div id="app">
    <div id="arena" class="screen active">
        <div class="card">
            <h3>–ò–≥—Ä—ã</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="s-snake" onclick="setGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
                <button class="btn" style="opacity:0.5" id="s-tetris" onclick="setGame('tetris')">üß± –¢–µ—Ç—Ä–∏—Å</button>
            </div>
        </div>
        <div id="arena-menu" class="card">
            <h4 id="mode-info">–í—ã–±—Ä–∞–Ω–æ: –ó–º–µ–π–∫–∞</h4>
            <button class="btn" onclick="preStart()">üî• –ì–û–¢–û–í (–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞)</button>
            <button class="btn" style="background:none; color:var(--btn); border:1px solid var(--btn)" id="friend-btn">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –° –î–†–£–ì–û–ú</button>
        </div>
        <div id="game-ui" style="display:none; flex-direction:column; align-items:center;">
            <div id="countdown">3</div>
            <div id="score" style="font-size:20px; font-weight:bold; margin-bottom:5px;">Score: 0</div>
            <canvas id="gameCanvas" width="300" height="450"></canvas>
            <div id="game-ctrls" class="controls">
                <div></div><button class="ctrl-btn" onclick="handleInput('up')">‚Üë</button><div></div>
                <button class="ctrl-btn" onclick="handleInput('left')">‚Üê</button>
                <button class="ctrl-btn" onclick="handleInput('down')">‚Üì</button>
                <button class="ctrl-btn" onclick="handleInput('right')">‚Üí</button>
            </div>
            <button class="btn" style="background:red; width:120px; margin-top:15px;" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="search" class="screen">
        <div class="card">
            <h3>–†–∞–Ω–¥–æ–º–Ω—ã–π —Å–æ–ø–µ—Ä–Ω–∏–∫</h3>
            <p>–°—Ç–∞–≤–∫–∞ (Stars):</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" onclick="startRandom(10)">10</button>
                <button class="btn" onclick="startRandom(50)">50</button>
                <button class="btn" onclick="startRandom(100)">100</button>
                <button class="btn" onclick="startRandom(1000)">1000</button>
            </div>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">Player</h2>
            <div style="font-size:36px; font-weight:800; color:var(--btn)">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <div class="card">
            <input type="number" id="pay-amt" value="50" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            <button class="btn" onclick="pay()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
            <button class="btn" style="background:#ff3b30" onclick="withdraw()">–í–´–í–û–î –°–†–ï–î–°–¢–í</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)"><span>üéÆ</span>–ê—Ä–µ–Ω–∞</div>
        <div class="nav-item" onclick="tab('search', this)"><span>üîç</span>–ü–æ–∏—Å–∫</div>
        <div class="nav-item" onclick="tab('profile', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', moveDir = {x:1, y:0};
    let gameLoop;

    tg.expand();

    async function load() {
        const r = await fetch(`${API}/api/user-data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData })
        });
        const d = await r.json();
        balance = d.balance;
        document.getElementById('u-balance').innerText = balance;
        document.getElementById('u-name').innerText = d.name;
    }

    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–õ–ê–í–ò–ê–¢–£–†–û–ô (–ü–ö)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp') handleInput('up');
        if (e.key === 'ArrowDown') handleInput('down');
        if (e.key === 'ArrowLeft') handleInput('left');
        if (e.key === 'ArrowRight') handleInput('right');
    });

    function handleInput(dir) {
        if (currentGame === 'snake') {
            if (dir === 'up' && moveDir.y === 0) moveDir = {x:0, y:-1};
            if (dir === 'down' && moveDir.y === 0) moveDir = {x:0, y:1};
            if (dir === 'left' && moveDir.x === 0) moveDir = {x:-1, y:0};
            if (dir === 'right' && moveDir.x === 0) moveDir = {x:1, y:0};
        } else if (currentGame === 'tetris') {
            if (dir === 'left') tetrisMove(-1);
            if (dir === 'right') tetrisMove(1);
            if (dir === 'down') tetrisDrop();
            if (dir === 'up') tetrisRotate();
        }
    }

    // –¢–ï–¢–†–ò–°
    let board, piece, tetrisScore;
    function runTetris() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        board = Array(20).fill().map(() => Array(10).fill(0));
        tetrisScore = 0;
        spawnPiece();
        gameLoop = setInterval(() => {
            tetrisDrop();
            drawTetris(ctx);
        }, 800);
    }

    function spawnPiece() {
        const types = ['I','J','L','O','S','T','Z'];
        const t = types[Math.floor(Math.random()*7)];
        piece = { pos: {x: 4, y: 0}, matrix: createPiece(t) };
    }

    function createPiece(type) {
        if (type === 'I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
        if (type === 'T') return [[0,1,0],[1,1,1],[0,0,0]];
        if (type === 'O') return [[1,1],[1,1]];
        if (type === 'J') return [[0,1,0],[0,1,0],[1,1,0]];
        if (type === 'L') return [[0,1,0],[0,1,0],[0,1,1]];
        if (type === 'S') return [[0,1,1],[1,1,0],[0,0,0]];
        if (type === 'Z') return [[1,1,0],[0,1,1],[0,0,0]];
    }

    function tetrisDrop() {
        piece.pos.y++;
        if (collide()) {
            piece.pos.y--;
            merge();
            spawnPiece();
            clearLines();
        }
    }

    function collide() {
        const [m, o] = [piece.matrix, piece.pos];
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < m[y].length; ++x) {
                if (m[y][x] !== 0 && (board[y + o.y] && board[y + o.y][x + o.x]) !== 0) return true;
            }
        }
        return false;
    }

    function merge() {
        piece.matrix.forEach((row, y) => {
            row.forEach((value, x) => {
                if (value !== 0) board[y + piece.pos.y][x + piece.pos.x] = value;
            });
        });
    }

    function clearLines() {
        outer: for (let y = board.length - 1; y > 0; --y) {
            for (let x = 0; x < board[y].length; ++x) {
                if (board[y][x] === 0) continue outer;
            }
            const row = board.splice(y, 1)[0].fill(0);
            board.unshift(row);
            tetrisScore += 10;
            document.getElementById('score').innerText = "Score: " + tetrisScore;
        }
    }

    function drawTetris(ctx) {
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 300, 450);
        board.forEach((row, y) => row.forEach((val, x) => {
            if (val) { ctx.fillStyle = '#2481cc'; ctx.fillRect(x*30, y*22.5, 29, 21.5); }
        }));
        piece.matrix.forEach((row, y) => row.forEach((val, x) => {
            if (val) { ctx.fillStyle = '#fff'; ctx.fillRect((x+piece.pos.x)*30, (y+piece.pos.y)*22.5, 29, 21.5); }
        }));
    }

    function tetrisMove(dir) { piece.pos.x += dir; if(collide()) piece.pos.x -= dir; }
    function tetrisRotate() { 
        const old = piece.matrix;
        piece.matrix = piece.matrix[0].map((_, i) => piece.matrix.map(row => row[i]).reverse());
        if(collide()) piece.matrix = old;
    }

    // –ó–ú–ï–ô–ö–ê
    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5}, score = 0;
        gameLoop = setInterval(() => {
            let h = {x: s[0].x + moveDir.x, y: s[0].y + moveDir.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=30) return location.reload();
            s.unshift(h);
            if(h.x===f.x && h.y===f.y) {
                score++; document.getElementById('score').innerText = "Score: "+score;
                f = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*20)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,450);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    // –õ–û–ë–ë–ò –ò –ò–ù–í–ê–ô–¢–´
    async function checkInvite() {
        const startParam = tg.initDataUnsafe.start_param;
        if (startParam && startParam.startsWith('lobby_')) {
            const lobbyId = startParam.replace('lobby_', '');
            tg.showConfirm(`–í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã –≤ –ª–æ–±–±–∏! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è?`, async (ok) => {
                if (ok) {
                    const r = await fetch(`${API}/api/join-lobby`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ initData: tg.initData, lobbyId })
                    });
                    const lobby = await r.json();
                    if (lobby.status === 'ready' || lobby.players.length > 0) preStart();
                }
            });
        }
    }

    document.getElementById('friend-btn').onclick = () => {
        const lobbyId = Math.random().toString(36).substr(2, 9);
        tg.switchInlineQuery(`lobby_${lobbyId}`, ['users', 'chats']);
    };

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('s-snake').style.opacity = g==='snake'?1:0.5;
        document.getElementById('s-tetris').style.opacity = g==='tetris'?1:0.5;
        document.getElementById('mode-info').innerText = "–í—ã–±—Ä–∞–Ω–æ: " + (g==='snake'?'–ó–º–µ–π–∫–∞':'–¢–µ—Ç—Ä–∏—Å');
    }

    function preStart() {
        document.getElementById('arena-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        let c = 3;
        const t = setInterval(() => {
            cd.innerText = c;
            c--;
            if(c < 0) {
                clearInterval(t);
                cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('game-ctrls').style.display = 'grid';
                if(currentGame==='snake') runSnake(); else runTetris();
            }
        }, 1000);
    }

    function startRandom(bet) {
        if(balance < bet) return tg.showAlert("–ú–∞–ª–æ Stars!");
        tg.showAlert("–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –Ω–∞ " + bet + " Stars –Ω–∞—á–∞—Ç...");
    }

    async function pay() {
        const a = document.getElementById('pay-amt').value;
        const r = await fetch(`${API}/api/create-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(a) })
        });
        const { invoiceLink } = await r.json();
        tg.openInvoice(invoiceLink, (st) => { if(st==='paid') load(); });
    }

    async function withdraw() {
        const a = prompt("–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞:");
        if(!a || a < 50) return tg.showAlert("–ú–∏–Ω–∏–º—É–º 50 Stars");
        const r = await fetch(`${API}/api/withdraw`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(a) })
        });
        if(r.ok) { tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏."); load(); }
    }

    async function init() {
        await load();
        checkInvite();
    }
    init();
</script>
</body>
</html>
