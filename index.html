<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #1c1c1e);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-btn: var(--tg-theme-button-color, #2481cc);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-sec-bg: var(--tg-theme-secondary-bg-color, #2c2c2e);
            --accent-neon: #00f0ff; --accent-pink: #ff0055; --font-retro: 'Press Start 2P', cursive;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--tg-bg); color: var(--tg-text); font-family: -apple-system, sans-serif; height: 100vh; width: 100vw; overflow: hidden; position: relative; user-select: none; -webkit-user-select: none; }
        
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 70px); flex-direction: column; align-items: center; overflow-y: auto; padding: 20px; padding-bottom: 50px; -webkit-overflow-scrolling: touch; }
        .screen.active { display: flex; }
        
        .screen::-webkit-scrollbar { width: 5px; }
        .screen::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        h1, h2 { font-family: var(--font-retro); text-transform: uppercase; margin-bottom: 20px; text-shadow: 2px 2px 0px rgba(0,0,0,0.5); text-align: center; }
        h1 { font-size: 1.5rem; color: var(--accent-neon); margin-top: 10px; }
        
        .card { background: var(--tg-sec-bg); border-radius: 12px; padding: 16px; width: 100%; max-width: 350px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; }
        
        .btn { background: var(--tg-btn); color: var(--tg-btn-text); border: none; border-radius: 8px; padding: 14px; width: 100%; font-size: 0.8rem; font-weight: bold; font-family: var(--font-retro); text-transform: uppercase; cursor: pointer; margin-bottom: 10px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--tg-btn); color: var(--tg-btn); }
        .btn-danger { background: var(--accent-pink); color: white; }
        .btn-crypto { background: #2AABEE; color: white; border: none; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.7rem; margin-bottom: 0; }

        select, input { background: var(--tg-bg); color: var(--tg-text); border: 1px solid var(--tg-btn); padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; font-size: 1rem; }

        canvas { border: 4px solid var(--tg-text); border-radius: 4px; background: #000; image-rendering: pixelated; width: 100%; max-width: 300px; height: auto; margin-bottom: 15px; flex-shrink: 0; }

        .game-ui-bottom { width: 100%; display: flex; justify-content: center; margin-top: 10px; padding-bottom: 20px; flex-shrink: 0; }
        .d-pad-container { display: grid; grid-template-areas: ". up ." "left down right"; gap: 10px; }
        .ctrl-btn { width: 65px; height: 65px; background: rgba(255,255,255,0.1); border: 2px solid var(--tg-text); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; touch-action: manipulation; }
        .ctrl-btn:active { background: var(--accent-neon); color: black; border-color: var(--accent-neon); }
        .btn-up { grid-area: up; } .btn-left { grid-area: left; } .btn-down { grid-area: down; } .btn-right { grid-area: right; }

        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--tg-sec-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; padding-bottom: 10px; }
        .tab { display: flex; flex-direction: column; align-items: center; color: var(--tg-text); opacity: 0.5; font-size: 0.7rem; cursor: pointer; width: 100%; }
        .tab.active { opacity: 1; color: var(--accent-neon); }
        .tab-icon { font-size: 1.5rem; margin-bottom: 4px; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; align-items:center; justify-content:center; flex-direction:column; overflow-y:auto; padding: 20px; }
        
        .admin-row { font-size: 0.7rem; border-bottom: 1px solid #444; padding: 5px; display: flex; justify-content: space-between; }
        #admin-panel { display: none; border: 2px solid gold; }
    </style>
</head>
<body>

<div id="app">
    <!-- PLAY -->
    <div id="s-play" class="screen active">
        <h1>RETRO ARENA</h1>
        <div class="card">
            <h2>Solo Training</h2>
            <button class="btn btn-outline" onclick="launchGame('snake', false)">üêç Snake</button>
            <button class="btn btn-outline" onclick="launchGame('tetris', false)">üß± Tetris</button>
        </div>
        <div class="card" style="border: 2px solid var(--accent-neon);">
            <h2>Ranked Match</h2>
            <select id="search-game"><option value="snake">Snake</option><option value="tetris">Tetris</option></select>
            <select id="search-bet"><option value="10">10 ‚≠êÔ∏è</option><option value="50">50 ‚≠êÔ∏è</option><option value="100">100 ‚≠êÔ∏è</option><option value="500">500 ‚≠êÔ∏è</option></select>
            <button class="btn" onclick="startMatchmaking()">üîç FIND MATCH</button>
        </div>
        <div class="card">
            <h2>Friend Match</h2>
            <button class="btn btn-outline" onclick="openFriendModal()">üîó CREATE LINK</button>
        </div>
    </div>

    <!-- SEARCH -->
    <div id="s-search" class="screen" style="justify-content: center;">
        <h1>SEARCHING...</h1>
        <button class="btn btn-danger" onclick="cancelMatchmaking()">CANCEL</button>
    </div>

    <!-- PROFILE -->
    <div id="s-profile" class="screen">
        <h1>PROFILE</h1>
        
        <div class="card" style="text-align: center;">
            <div style="font-size: 3rem; font-family: var(--font-retro); color: gold;">
                <span id="p-bal">0</span>
            </div>
            <div style="opacity: 0.7;">VIRTUAL STARS BALANCE</div>
        </div>

        <div class="card">
            <h2>Stats</h2>
            <div class="stat-row"><span>ID:</span> <span id="p-id">...</span></div>
            <div class="stat-row"><span>Best Snake:</span> <span id="p-snake">0</span></div>
            <div class="stat-row"><span>Best Tetris:</span> <span id="p-tetris">0</span></div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="admin-panel" class="card">
            <h2 style="color: gold;">ADMIN PANEL</h2>
            <div class="admin-row" style="margin-bottom: 10px; font-size: 0.9rem;">
                <span style="font-weight: bold;">Total Commission:</span> 
                <span id="adm-commission" style="color:var(--accent-neon); font-weight:bold;">0‚òÖ</span>
            </div>
            <button class="btn btn-sm" onclick="loadAdminData()">REFRESH DATA</button>
            <br><br>
            <div style="text-align: left;">
                <h4 style="margin: 5px 0;">Withdrawal Requests:</h4>
                <div id="adm-withdrawals" style="max-height: 150px; overflow-y: auto; background: #000; padding: 5px;"></div>
                
                <h4 style="margin: 10px 0 5px;">Recent Matches:</h4>
                <div id="adm-matches" style="max-height: 150px; overflow-y: auto; background: #000; padding: 5px;"></div>

                <h4 style="margin: 10px 0 5px;">Manual Balance:</h4>
                <input type="number" id="adm-target-id" placeholder="User ID">
                <input type="number" id="adm-new-bal" placeholder="New Balance">
                <button class="btn btn-danger btn-sm" onclick="adminSetBalance()">SET BALANCE</button>
            </div>
        </div>

        <div class="card">
            <h2>Deposit</h2>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-crypto" onclick="depositCrypto('USDT', 1, 100)">CryptoBot 1 USDT (+100‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('TON', 1, 500)">CryptoBot 1 TON (+500‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('NOT', 1000, 1000)">CryptoBot 1000 NOT (+1000‚òÖ)</button>
            </div>
        </div>
        <button class="btn btn-danger" onclick="withdraw()">WITHDRAW FUNDS</button>
        <div style="height: 20px;"></div>
    </div>

    <!-- GAME -->
    <div id="s-game" class="screen" style="padding-top: 10px;">
        <div class="game-header">
            <div style="display: flex; gap: 5px;">
                <button class="btn btn-danger btn-sm" onclick="quitGame()">EXIT</button>
                <button class="btn btn-outline btn-sm" onclick="restartGame()" id="btn-restart-header" style="display:none;">‚Üª</button>
            </div>
            <div style="font-family: var(--font-retro); color: gold;">SCORE: <span id="g-score">0</span></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="game-ui-bottom">
            <div class="d-pad-container">
                <div class="ctrl-btn btn-up" ontouchstart="input('up', event)">‚ñ≤</div>
                <div class="ctrl-btn btn-left" ontouchstart="input('left', event)">‚óÄ</div>
                <div class="ctrl-btn btn-down" ontouchstart="input('down', event)">‚ñº</div>
                <div class="ctrl-btn btn-right" ontouchstart="input('right', event)">‚ñ∂</div>
            </div>
        </div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="nav('play', this)"><div class="tab-icon">üéÆ</div><div>PLAY</div></div>
    <div class="tab" onclick="nav('profile', this)"><div class="tab-icon">üë§</div><div>PROFILE</div></div>
</div>

<!-- MODALS -->
<div id="modal-over" class="modal">
    <h1 style="color:red; font-size:3rem; text-align: center;">GAME<br>OVER</h1>
    <h2 id="end-score" style="color:white;">0</h2>
    <p id="end-msg" style="color:gold;"></p>
    <button class="btn" style="width:240px;" onclick="restartGameFromModal()">PLAY AGAIN</button>
    <button class="btn btn-outline" style="width:240px;" onclick="location.reload()">MENU</button>
</div>

<div id="modal-friend" class="modal">
    <div class="card" style="width: 85%;">
        <h2>Invite Friend</h2>
        <select id="f-game"><option value="snake">Snake</option><option value="tetris">Tetris</option></select>
        <select id="f-bet"><option value="10">10 ‚≠êÔ∏è</option><option value="50">50 ‚≠êÔ∏è</option><option value="100">100 ‚≠êÔ∏è</option><option value="500">500 ‚≠êÔ∏è</option></select>
        <button class="btn" onclick="submitFriendLobby()">GENERATE LINK</button>
        <button class="btn btn-outline" onclick="document.getElementById('modal-friend').style.display='none'">CANCEL</button>
    </div>
</div>

<script>
    const API = "https://tg-game-arena.onrender.com";
    const ADMIN_ID = 1463465416;
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
    
    let user = null, lobby = null, poll = null, loop = null, gameType = '', score = 0;
    const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    canvas.width = 240 * dpr; canvas.height = 400 * dpr; ctx.scale(dpr, dpr);
    canvas.style.width = '240px'; canvas.style.height = '400px';

    async function init() {
        const r = await fetch(`${API}/api/user-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
        user = await r.json(); updateUI();
        
        if (user.telegramId === ADMIN_ID) {
            document.getElementById('admin-panel').style.display = 'block';
            loadAdminData();
        }

        if (tg.initDataUnsafe.start_param) {
            const j = await fetch(`${API}/api/join-lobby`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, startParam: tg.initDataUnsafe.start_param }) });
            const d = await j.json();
            if (d.mode === 'duel') { lobby = d.lobby; launchGame(lobby.gameType, true); }
            else if (d.error) tg.showAlert(d.error);
        }
    }
    init();

    function nav(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`s-${id}`).classList.add('active');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }

    function updateUI() {
        document.getElementById('p-bal').innerText = user.balance;
        document.getElementById('p-id').innerText = user.telegramId;
        document.getElementById('p-snake').innerText = user.highScores.snake;
        document.getElementById('p-tetris').innerText = user.highScores.tetris;
    }

    // --- ADMIN FUNCTIONS ---
    async function loadAdminData() {
        const r = await fetch(`${API}/api/admin/data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ adminId: user.telegramId }) });
        const d = await r.json();
        
        document.getElementById('adm-commission').innerText = (d.adminCommission || 0) + '‚òÖ';

        const wDiv = document.getElementById('adm-withdrawals');
        wDiv.innerHTML = d.withdrawals.map(w => `
            <div class="admin-row">
                <span>ID: ${w.telegramId}</span>
                <span style="color:gold">${w.amount}‚òÖ</span>
                <span>${new Date(w.date).toLocaleDateString()}</span>
            </div>
        `).join('');

        const mDiv = document.getElementById('adm-matches');
        mDiv.innerHTML = d.matches.map(m => `
            <div class="admin-row">
                <span>Win: ${m.winnerId}</span>
                <span style="color:gold">+${m.prize}</span>
                <span>${m.gameType}</span>
            </div>
        `).join('');
    }

    async function adminSetBalance() {
        const tid = document.getElementById('adm-target-id').value;
        const bal = document.getElementById('adm-new-bal').value;
        if(!tid || !bal) return;
        const r = await fetch(`${API}/api/admin/set-balance`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ adminId: user.telegramId, targetId: tid, newBalance: bal }) });
        const d = await r.json();
        if(d.success) tg.showAlert("Updated!");
    }

    // --- PAYMENTS (CRYPTOBOT) ---
    async function depositCrypto(asset, cryptoAmount, starsAmount) {
        const r = await fetch(`${API}/api/deposit`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ telegramId: user.telegramId, asset, amount: cryptoAmount, stars: starsAmount }) 
        });
        const d = await r.json(); 
        
        if (d.payUrl) {
            tg.openTelegramLink(d.payUrl);
            let checkingTimer = setInterval(async () => {
                const cur = await fetch(`${API}/api/user-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
                const curUser = await cur.json();
                if(curUser.balance > user.balance) {
                    user.balance = curUser.balance;
                    updateUI();
                    clearInterval(checkingTimer);
                    tg.showAlert("–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ!");
                }
            }, 3000);
            setTimeout(() => clearInterval(checkingTimer), 300000);
        } else {
            tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞");
        }
    }

    async function withdraw() {
        if(user.balance <= 0) return tg.showAlert("Empty balance");
        if(!confirm(`Send withdrawal request for ${user.balance} Stars?`)) return;
        const r = await fetch(`${API}/api/withdraw`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, amount: user.balance }) });
        const d = await r.json();
        if (d.success) { user.balance = d.newBalance; updateUI(); tg.showAlert("Request Sent!"); }
        else tg.showAlert(d.error);
    }

    // --- GAME & LOGIC ---
    function openFriendModal() { document.getElementById('modal-friend').style.display='flex'; }
    async function submitFriendLobby() {
        const g = document.getElementById('f-game').value, b = parseInt(document.getElementById('f-bet').value);
        if (user.balance < b) return tg.showAlert("Insufficient Stars");
        const r = await fetch(`${API}/api/create-lobby-friend`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, gameType: g, betAmount: b }) });
        const d = await r.json();
        if (d.success) {
            const link = `https://t.me/share/url?url=https://t.me/RetroBattleArena_bot/app?startapp=${d.lobbyId}&text=Duel me in ${g}!`;
            tg.openTelegramLink(link); document.getElementById('modal-friend').style.display='none';
        }
    }

    async function startMatchmaking() {
        const g = document.getElementById('search-game').value, b = parseInt(document.getElementById('search-bet').value);
        if (user.balance < b) return tg.showAlert("Insufficient Stars");
        nav('search', document.querySelectorAll('.tab'));
        const r = await fetch(`${API}/api/search-match`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, gameType: g, betAmount: b }) });
        const d = await r.json();
        if (d.status === 'match_found') { lobby = { lobbyId: d.lobbyId, betAmount: b }; launchGame(g, true); }
        else { poll = setInterval(async () => {
            const cr = await fetch(`${API}/api/check-match-status`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId }) });
            const cd = await cr.json(); if (cd.status === 'match_found') { clearInterval(poll); lobby = cd.lobby; launchGame(lobby.gameType, true); }
        }, 3000); }
    }

    async function cancelMatchmaking() {
        clearInterval(poll);
        await fetch(`${API}/api/cancel-match`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId }) });
        location.reload();
    }

    function launchGame(t, pvp) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('s-game').classList.add('active');
        document.querySelector('.tabs').style.display = 'none';
        document.getElementById('btn-restart-header').style.display = pvp ? 'none' : 'block';
        gameType = t; score = 0; document.getElementById('g-score').innerText = 0;
        if (t === 'snake') runSnake(); else runTetris();
    }

    function quitGame() { if(confirm("Quit?")) location.reload(); }
    function restartGame() { if(loop) cancelAnimationFrame(loop); clearTimeout(loop); score=0; document.getElementById('g-score').innerText=0; if(gameType==='snake') runSnake(); else runTetris(); }
    function restartGameFromModal() { document.getElementById('modal-over').style.display='none'; restartGame(); }

    async function gameOver() {
        if(loop) cancelAnimationFrame(loop); clearTimeout(loop);
        document.getElementById('modal-over').style.display='flex';
        document.getElementById('end-score').innerText = score;
        await fetch(`${API}/api/submit-score`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ telegramId: user.telegramId, game: gameType, score, lobbyId: lobby ? lobby.lobbyId : null }) });
    }

    function input(k, e) { e.preventDefault(); document.dispatchEvent(new KeyboardEvent('keydown', { key: k==='up'?'ArrowUp':k==='down'?'ArrowDown':k==='left'?'ArrowLeft':'ArrowRight' })); }

    function runSnake() {
        let s =, f = {x:2,y:2}, d = {x:0,y:0};
        function upd() {
            let h = {x:s.x+d.x, y:s.y+d.y};
            if(h.x<0||h.x>=12||h.y<0||h.y>=20||( (d.x||d.y) && s.some(p=>p.x===h.x&&p.y===h.y))) return gameOver();
            if(d.x||d.y) s.unshift(h);
            if(h.x===f.x && h.y===f.y) { score+=10; document.getElementById('g-score').innerText=score; f={x:Math.floor(Math.random()*12), y:Math.floor(Math.random()*20)}; }
            else if(d.x||d.y) s.pop();
            ctx.fillStyle='#000'; ctx.fillRect(0,0,240,400);
            ctx.fillStyle='#ff0055'; ctx.fillRect(f.x*20, f.y*20, 18, 18);
            ctx.fillStyle='#00f0ff'; s.forEach(p => ctx.fillRect(p.x*20, p.y*20, 18, 18));
            loop = setTimeout(() => requestAnimationFrame(upd), 150);
        }
        document.onkeydown = e => { 
             if(e.key==='ArrowLeft'&&d.x!==1) d={x:-1,y:0}; 
             if(e.key==='ArrowRight'&&d.x!==-1) d={x:1,y:0}; 
             if(e.key==='ArrowUp'&&d.y!==1) d={x:0,y:-1}; 
             if(e.key==='ArrowDown'&&d.y!==-1) d={x:0,y:1}; 
             if(!d.x && !d.y) d={x:0,y:1};
        };
        upd();
    }

    function runTetris() {
        const R=20, C=12; 
        let bd = Array.from({length:R}, () => Array(C).fill(0));
        
        const SH =],,],,], 
            [,],,],,],,]
        ];
        
        const CL =;
        
        let p = { m: SH, c: Math.floor(Math.random()*7)+1, x: 4, y: 0 }, dc=0, lt=0;
        
        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,240,400);
            bd.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle=CL; ctx.fillRect(x*20,y*20,19,19); }}));
            p.m.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle=CL; ctx.fillRect((p.x+x)*20,(p.y+y)*20,19,19); }}));
        }
        
        function coll(ax, ay, m) { 
            return m.some((r,y)=>r.some((v,x)=> v && (bd === undefined || bd === undefined || bd !== 0))); 
        }
        
        function rotate(m) { 
            let nm=m.map((_,i)=>m.map(r=>r).reverse()); 
            if(!coll(0,0,nm)) p.m=nm; 
        }
        
        function upd(t=0) {
            dc += t - lt; lt = t;
            if(dc > 1000) {
                if(!coll(0,1,p.m)) p.y++;
                else {
                    p.m.forEach((r,y)=>r.forEach((v,x)=>{ if(v) bd=p.c; }));
                    bd.forEach((r,y)=>{ if(r.every(v=>v!==0)){ bd.splice(y,1); bd.unshift(Array(C).fill(0)); score+=100; document.getElementById('g-score').innerText=score; }});
                    p = { m: SH, c: Math.floor(Math.random()*7)+1, x: 4, y: 0 };
                    if(coll(0,0,p.m)) return gameOver();
                }
                dc=0;
            }
            draw(); loop = requestAnimationFrame(upd);
        }
        
        document.onkeydown = e => {
            if(e.key==='ArrowLeft' && !coll(-1,0,p.m)) p.x--;
            if(e.key==='ArrowRight' && !coll(1,0,p.m)) p.x++;
            if(e.key==='ArrowDown' && !coll(0,1,p.m)) p.y++;
            if(e.key==='ArrowUp') rotate(p.m);
        };
        upd();
    }
</script>
</body>
</html>
