<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #f0f0f2);
            --text: var(--tg-theme-text-color, #000000);
        }
        body { background: var(--sec-bg); color: var(--text); margin: 0; font-family: -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; }
        
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }

        .card { background: var(--sec-bg); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; text-align: center; box-sizing: border-box; }
        .btn { background: var(--btn); color: var(--btn-text); border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        
        canvas { background: #000; border-radius: 8px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #countdown { font-size: 80px; font-weight: bold; color: var(--btn); display: none; margin: 40px; }

        .controls { display: none; grid-template-columns: repeat(3, 70px); gap: 10px; margin-top: 15px; }
        .ctrl-btn { width: 70px; height: 70px; background: var(--sec-bg); border-radius: 50%; border: 1px solid #ddd; font-size: 24px; color: var(--text); }

        #nav { display: flex; background: var(--bg); height: 65px; border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: var(--hint); cursor: pointer; }
        .nav-item.active { color: var(--btn); }
    </style>
</head>
<body>

<div id="app">
    <div id="arena" class="screen active">
        <div class="card">
            <h3>–ò–≥—Ä—ã</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="s-snake" onclick="setGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
                <button class="btn" style="opacity:0.5" id="s-tetris" onclick="setGame('tetris')">üß± –¢–µ—Ç—Ä–∏—Å</button>
            </div>
        </div>
        
        <div id="arena-menu" class="card">
            <h4 id="mode-info">–í—ã–±—Ä–∞–Ω–æ: –ó–º–µ–π–∫–∞</h4>
            <button class="btn" onclick="preStart()">üî• –ì–û–¢–û–í (–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞)</button>
            <button class="btn" style="background:none; color:var(--btn); border:1px solid var(--btn)" onclick="tg.switchInlineQuery('invite', ['users'])">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –° –î–†–£–ì–û–ú</button>
        </div>

        <div id="game-ui" style="display:none; flex-direction:column; align-items:center;">
            <div id="countdown">3</div>
            <div id="score" style="font-size:20px; font-weight:bold; margin-bottom:5px;">Score: 0</div>
            <canvas id="gameCanvas" width="300" height="400"></canvas>
            
            <div id="game-ctrls" class="controls">
                <div></div><button class="ctrl-btn" onclick="move(0,-1)">‚Üë</button><div></div>
                <button class="ctrl-btn" onclick="move(-1,0)">‚Üê</button>
                <button class="ctrl-btn" onclick="move(0,1)">‚Üì</button>
                <button class="ctrl-btn" onclick="move(1,0)">‚Üí</button>
            </div>
            <button class="btn" style="background:red; width:120px; margin-top:15px;" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="search" class="screen">
        <div class="card">
            <h3>–†–∞–Ω–¥–æ–º–Ω—ã–π —Å–æ–ø–µ—Ä–Ω–∏–∫</h3>
            <p>–°—Ç–∞–≤–∫–∞ (Stars):</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ 10')">10</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ 50')">50</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ 100')">100</button>
                <button class="btn" onclick="tg.showAlert('–ü–æ–∏—Å–∫ 1000')">1000</button>
            </div>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">Player</h2>
            <div style="font-size:36px; font-weight:800; color:var(--btn)">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <div class="card">
            <input type="number" id="pay-amt" value="50" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
            <button class="btn" onclick="pay()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
            <button class="btn" style="background:#ff3b30" onclick="withdraw()">–í–´–í–û–î –°–†–ï–î–°–¢–í</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)"><span>üéÆ</span>–ê—Ä–µ–Ω–∞</div>
        <div class="nav-item" onclick="tab('search', this)"><span>üîç</span>–ü–æ–∏—Å–∫</div>
        <div class="nav-item" onclick="tab('profile', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', moveDir = {x:1, y:0};

    tg.expand();

    async function load() {
        const r = await fetch(`${API}/api/user-data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData })
        });
        const d = await r.json();
        balance = d.balance;
        document.getElementById('u-balance').innerText = balance;
        document.getElementById('u-name').innerText = d.name;
    }

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('s-snake').style.opacity = g==='snake'?1:0.5;
        document.getElementById('s-tetris').style.opacity = g==='tetris'?1:0.5;
        document.getElementById('mode-info').innerText = "–í—ã–±—Ä–∞–Ω–æ: " + (g==='snake'?'–ó–º–µ–π–∫–∞':'–¢–µ—Ç—Ä–∏—Å');
    }

    function move(x, y) { moveDir = {x, y}; }

    function preStart() {
        document.getElementById('arena-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        let c = 3;
        const t = setInterval(() => {
            cd.innerText = c;
            c--;
            if(c < 0) {
                clearInterval(t);
                cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('game-ctrls').style.display = 'grid';
                if(currentGame==='snake') runSnake(); else runTetris();
            }
        }, 1000);
    }

    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5}, score = 0;
        setInterval(() => {
            let h = {x: s[0].x + moveDir.x, y: s[0].y + moveDir.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=26) return location.reload();
            s.unshift(h);
            if(h.x===f.x && h.y===f.y) {
                score++; document.getElementById('score').innerText = "Score: "+score;
                f = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*20)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,400);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    function runTetris() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,400);
        ctx.fillStyle = "#fff"; ctx.fillText("TETRIS LOADING...", 100, 200);
        tg.showAlert("–¢–µ—Ç—Ä–∏—Å –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤! –ü–æ–∫–∞ –∏–≥—Ä–∞–π –≤ –ó–º–µ–π–∫—É.");
    }

    async function pay() {
        const a = document.getElementById('pay-amt').value;
        const r = await fetch(`${API}/api/create-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(a) })
        });
        const { invoiceLink } = await r.json();
        tg.openInvoice(invoiceLink, (st) => { if(st==='paid') load(); });
    }

    async function withdraw() {
        const a = prompt("–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞:");
        if(a < 50) return tg.showAlert("–ú–∏–Ω–∏–º—É–º 50 Stars");
        const r = await fetch(`${API}/api/withdraw`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(a) })
        });
        if(r.ok) { tg.showAlert("–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!"); load(); }
    }

    load();
</script>
</body>
</html>
