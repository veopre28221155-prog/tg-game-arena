<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #f0f0f2);
            --text: var(--tg-theme-text-color, #000000);
        }
        body { background: var(--sec-bg); color: var(--text); margin: 0; font-family: -apple-system, sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }

        .card { background: var(--sec-bg); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; box-sizing: border-box; }
        .btn { background: var(--btn); color: var(--btn-text); border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        .btn-sec { background: none; color: var(--btn); border: 1px solid var(--btn); }

        canvas { background: #000; border-radius: 8px; margin: 10px 0; display: none; }
        
        #nav { display: flex; background: var(--bg); height: 60px; border-top: 1px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: var(--hint); cursor: pointer; }
        .nav-item.active { color: var(--btn); }
        
        .game-controls { display: none; grid-template-columns: repeat(3, 60px); gap: 10px; margin-top: 10px; }
        .ctrl-btn { width: 60px; height: 60px; background: var(--sec-bg); border: none; border-radius: 50%; font-size: 20px; color: var(--text); }
    </style>
</head>
<body>

<div id="app">
    <div id="arena" class="screen active">
        <div class="card">
            <h2 style="margin:0">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</h2>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" onclick="setGame('snake')">–ó–º–µ–π–∫–∞ üêç</button>
                <button class="btn" onclick="setGame('tetris')">–¢–µ—Ç—Ä–∏—Å üß±</button>
            </div>
        </div>

        <div id="mode-selection" class="card">
            <p id="selected-game-txt">–ò–≥—Ä–∞: –ó–º–µ–π–∫–∞</p>
            <button class="btn btn-sec" onclick="startFree()">üéØ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</button>
            <button class="btn" onclick="openLobby()">‚öîÔ∏è –ò–≥—Ä–∞ —Å –¥—Ä—É–≥–æ–º</button>
            <button class="btn" onclick="tg.showAlert('–†–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å–∫–æ—Ä–æ!')">üé≤ –†–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ–∏—Å–∫</button>
        </div>

        <div id="game-ui" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <div id="game-info">–°—á–µ—Ç: 0</div>
            <canvas id="gameCanvas" width="300" height="300"></canvas>
            
            <div id="snake-ctrls" class="game-controls">
                <div></div><button class="ctrl-btn" onclick="snakeDir={x:0,y:-1}">‚Üë</button><div></div>
                <button class="ctrl-btn" onclick="snakeDir={x:-1,y:0}">‚Üê</button>
                <button class="ctrl-btn" onclick="snakeDir={x:0,y:1}">‚Üì</button>
                <button class="ctrl-btn" onclick="snakeDir={x:1,y:0}">‚Üí</button>
            </div>
            <button class="btn" style="background:red; width:120px" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">–ò–≥—Ä–æ–∫</h2>
            <div style="font-size: 32px; font-weight: bold;">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <div class="card">
            <input type="number" id="pay-amt" value="50" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px">
            <button class="btn" onclick="pay()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å Stars</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)"><span>üéÆ</span>–ê—Ä–µ–Ω–∞</div>
        <div class="nav-item" onclick="tab('profile', this)"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', snakeDir = {x:1, y:0};

    tg.expand();

    async function load() {
        const r = await fetch(`${API}/api/user-data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData })
        });
        const d = await r.json();
        balance = d.balance;
        document.getElementById('u-balance').innerText = balance;
        document.getElementById('u-name').innerText = d.name;
    }

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('selected-game-txt').innerText = "–ò–≥—Ä–∞: " + (g === 'snake' ? '–ó–º–µ–π–∫–∞' : '–¢–µ—Ç—Ä–∏—Å');
    }

    function startFree() {
        document.getElementById('mode-selection').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('gameCanvas').style.display = 'block';
        if(currentGame === 'snake') {
            document.getElementById('snake-ctrls').style.display = 'grid';
            initSnake();
        } else {
            tg.showAlert("–¢–µ—Ç—Ä–∏—Å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –ó–º–µ–π–∫–∞!");
        }
    }

    function initSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let snake = [{x:10, y:10}], food = {x:5, y:5}, score = 0;
        setInterval(() => {
            let head = {x: snake[0].x + snakeDir.x, y: snake[0].y + snakeDir.y};
            if(head.x<0||head.x>=20||head.y<0||head.y>=20) return location.reload();
            snake.unshift(head);
            if(head.x===food.x && head.y===food.y) {
                score++;
                food = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*20)};
            } else { snake.pop(); }
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,300);
            ctx.fillStyle = "#2481cc"; snake.forEach(s=>ctx.fillRect(s.x*15, s.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(food.x*15, food.y*15, 14, 14);
        }, 150);
    }

    async function pay() {
        const amt = document.getElementById('pay-amt').value;
        const r = await fetch(`${API}/api/create-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(amt) })
        });
        const { invoiceLink } = await r.json();
        tg.openInvoice(invoiceLink, (s) => { if(s==='paid') load(); });
    }

    load();
</script>
</body>
</html>
