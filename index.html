<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Battle Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: #111111;
            --tg-text: #ffffff;
            --tg-btn: #0044cc;
            --tg-btn-text: #ffffff;
            --tg-sec-bg: #222222;
            --accent-neon: #00f0ff; 
            --accent-pink: #ff0055; 
            --font-retro: 'Press Start 2P', cursive;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--tg-bg); color: var(--tg-text); font-family: var(--font-retro); height: 100vh; width: 100vw; overflow: hidden; position: relative; user-select: none; -webkit-user-select: none; touch-action: none; }
        
        .screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 70px); flex-direction: column; align-items: center; overflow-y: auto; padding: 20px; padding-bottom: 50px; font-family: -apple-system, sans-serif; }
        .screen.active { display: flex; }
        
        h1, h2 { font-family: var(--font-retro); text-transform: uppercase; margin-bottom: 20px; text-align: center; }
        h1 { font-size: 1.4rem; color: var(--accent-neon); margin-top: 15px; line-height: 1.4; text-shadow: 0 0 5px var(--accent-neon); }
        
        .card { background: var(--tg-sec-bg); border-radius: 12px; padding: 16px; width: 100%; max-width: 350px; margin-bottom: 16px; border: 1px solid var(--accent-neon); box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); }
        .card-free { border-color: rgba(255, 255, 255, 0.2); box-shadow: none; }
        
        .btn { background: var(--tg-btn); color: var(--tg-btn-text); border: none; border-radius: 8px; padding: 14px; width: 100%; font-size: 0.8rem; font-weight: bold; font-family: var(--font-retro); text-transform: uppercase; cursor: pointer; margin-bottom: 10px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--tg-btn); color: var(--tg-btn); }
        .btn-danger { background: var(--accent-pink); color: white; border: none; }
        .btn-duel { background: linear-gradient(45deg, #ff0055, #ff8800); color: white; font-size: 1rem; padding: 18px; border: 2px solid #fff; animation: pulse 2s infinite; }
        .btn-crypto { background: #2AABEE; color: white; border: none; }
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.7rem; margin-bottom: 0; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        select, input { background: var(--tg-bg); color: var(--tg-text); border: 1px solid var(--tg-btn); padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; font-size: 1rem; font-family: -apple-system, sans-serif;}

        canvas { border: 4px solid var(--tg-text); border-radius: 4px; background: #000; width: 100% !important; max-width: 300px; height: auto !important; margin-bottom: 15px; flex-shrink: 0; image-rendering: pixelated; }

        .controls { display: flex; width: 100%; max-width: 320px; margin: 0 auto; justify-content: space-between; align-items: center; padding: 0 10px; }
        .d-pad-container { display: grid; grid-template-areas: ". up ." "left down right"; gap: 10px; }
        .ctrl-btn { width: 55px; height: 55px; background: rgba(255,255,255,0.1); border: 2px solid var(--tg-text); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; touch-action: manipulation; font-family: -apple-system, sans-serif; }
        .ctrl-btn:active { background: var(--accent-neon); color: black; border-color: var(--accent-neon); }
        .btn-up { grid-area: up; } .btn-left { grid-area: left; } .btn-down { grid-area: down; } .btn-right { grid-area: right; }
        
        .action-btn-container { display: flex; justify-content: center; align-items: center; }
        .btn-action { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,0,85,0.2); border-color: var(--accent-pink); }
        .btn-action:active { background: var(--accent-pink); }

        .tabs { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--tg-sec-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .tab { display: flex; flex-direction: column; align-items: center; color: var(--tg-text); opacity: 0.5; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; }
        .tab.active { opacity: 1; color: var(--accent-neon); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; align-items:center; justify-content:center; flex-direction:column; padding: 20px; }
        .admin-row { font-size: 0.7rem; border-bottom: 1px solid #444; padding: 5px; display: flex; justify-content: space-between; }
        #admin-panel { display: none; border: 2px solid gold; margin-top: 20px; }
        .stat-row { display: flex; justify-content: space-between; font-family: var(--font-retro); font-size: 0.7rem; margin-bottom: 8px; }
    </style>
</head>
<body>

<div id="app">
    <!-- MENU SCREEN -->
    <div id="s-play" class="screen active">
        <h1>RETRO BATTLE<br>ARENA</h1>
        <div class="card">
            <h2 style="color: var(--accent-neon); font-size: 1.1rem;">Ranked Match 1v1</h2>
            <p style="font-size:0.7rem; text-align:center; opacity:0.8; font-family: var(--font-retro);">Higher score wins!</p>
            <select id="search-game">
                <option value="airHockey">üèí Air Hockey</option>
                <option value="battleCity">üöú Battle City</option>
                <option value="roadFighter">üèé Road Fighter</option>
                <option value="spaceInvaders">üëæ Space Invaders</option>
                <option value="snake">üêç Classic Snake</option>
                <option value="tetris">üß± Tetris Block</option>
            </select>
            <select id="search-bet">
                <option value="10">Bet: 10 ‚≠êÔ∏è</option>
                <option value="50">Bet: 50 ‚≠êÔ∏è</option>
                <option value="100">Bet: 100 ‚≠êÔ∏è</option>
                <option value="500">Bet: 500 ‚≠êÔ∏è</option>
            </select>
            <button class="btn btn-duel" onclick="startMatchmaking()">‚öîÔ∏è FIND DUEL ‚öîÔ∏è</button>
        </div>
        <div class="card card-free">
            <h2 style="font-size: 1rem;">Solo Training</h2>
            <p style="font-size:0.7rem; text-align:center; opacity:0.7; font-family: var(--font-retro); margin-top: 0;">FREE PLAY</p>
            <button class="btn btn-outline" onclick="launchGame('airHockey', false)">üèí Play Air Hockey</button>
            <button class="btn btn-outline" onclick="launchGame('battleCity', false)">üöú Play Battle City</button>
            <button class="btn btn-outline" onclick="launchGame('roadFighter', false)">üèé Play Road Fighter</button>
            <button class="btn btn-outline" onclick="launchGame('spaceInvaders', false)">üëæ Play Space Invaders</button>
            <button class="btn btn-outline" onclick="launchGame('snake', false)">üêç Play Snake</button>
            <button class="btn btn-outline" onclick="launchGame('tetris', false)">üß± Play Tetris</button>
        </div>
    </div>

    <!-- SEARCH SCREEN -->
    <div id="s-search" class="screen" style="justify-content: center;">
        <h1 class="blink" style="color: #ff8800;">SEARCHING ENEMY...</h1>
        <button class="btn btn-danger" onclick="cancelMatchmaking()">CANCEL</button>
    </div>

    <!-- PROFILE SCREEN -->
    <div id="s-profile" class="screen">
        <h1>PROFILE</h1>
        <div class="card card-free" style="text-align: center;">
            <div style="font-size: 2.5rem; font-family: var(--font-retro); color: gold; text-shadow: 2px 2px 0 #000;"><span id="p-bal">0</span> ‚òÖ</div>
            <div style="opacity: 0.7; font-size: 0.8rem; margin-top: 10px; font-weight: bold;">VIRTUAL STARS</div>
        </div>
        <div class="card card-free">
            <h2 style="font-size: 1rem;">High Scores</h2>
            <div class="stat-row"><span>ID:</span> <span id="p-id">...</span></div>
            <div class="stat-row"><span>Air Hockey:</span> <span id="p-hockey" style="color:#ffffff;">0</span></div>
            <div class="stat-row"><span>Battle City:</span> <span id="p-battle" style="color:#ff8800;">0</span></div>
            <div class="stat-row"><span>Road Fighter:</span> <span id="p-road" style="color:#00f0ff;">0</span></div>
            <div class="stat-row"><span>Space Invaders:</span> <span id="p-space" style="color:#bc13fe;">0</span></div>
            <div class="stat-row"><span>Snake:</span> <span id="p-snake" style="color:#00ff00;">0</span></div>
            <div class="stat-row"><span>Tetris:</span> <span id="p-tetris" style="color:#ff0055;">0</span></div>
        </div>
        <div class="card card-free">
            <h2 style="font-size: 1rem;">Deposit (Crypto)</h2>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-crypto" onclick="depositCrypto('USDT', 1, 100)">1 USDT (+100‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('TON', 1, 500)">1 TON (+500‚òÖ)</button>
                <button class="btn btn-crypto" onclick="depositCrypto('NOT', 1000, 1000)">1000 NOT (+1000‚òÖ)</button>
            </div>
        </div>
        <button class="btn btn-danger" onclick="withdraw()">WITHDRAW FUNDS</button>
        <div id="admin-panel" class="card">
            <h2 style="color: gold; font-size: 1rem;">ADMIN PANEL</h2>
            <div class="admin-row" style="margin-bottom: 10px;"><span style="font-weight: bold;">Commission:</span><span id="adm-commission" style="color:var(--accent-neon);font-weight:bold;">0‚òÖ</span></div>
            <button class="btn btn-sm" onclick="loadAdminData()">REFRESH</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="s-game" class="screen" style="padding-top: 10px; padding-bottom: 0;">
        <div style="width: 100%; max-width: 300px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <button class="btn btn-danger btn-sm" style="margin:0;" onclick="quitGame()">GIVE UP</button>
            <div style="font-family: var(--font-retro); color: gold; font-size: 0.8rem;">SCORE: <span id="g-score">0</span><span id="g-time-box" style="display:none; color:white; margin-left: 10px;">üïí <span id="g-time">60</span></span></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="controls">
            <div class="d-pad-container">
                <div class="ctrl-btn btn-up" ontouchstart="press('up',true)" ontouchend="press('up',false)">‚ñ≤</div>
                <div class="ctrl-btn btn-left" ontouchstart="press('left',true)" ontouchend="press('left',false)">‚óÄ</div>
                <div class="ctrl-btn btn-down" ontouchstart="press('down',true)" ontouchend="press('down',false)">‚ñº</div>
                <div class="ctrl-btn btn-right" ontouchstart="press('right',true)" ontouchend="press('right',false)">‚ñ∂</div>
            </div>
            <div class="action-btn-container">
                <div class="ctrl-btn btn-action" ontouchstart="press('action',true)" ontouchend="press('action',false)">A</div>
            </div>
        </div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="nav('play', this)"><div class="tab-icon">üéÆ</div><div>PLAY</div></div>
    <div class="tab" onclick="nav('profile', this)"><div class="tab-icon">üë§</div><div>PROFILE</div></div>
</div>

<!-- GAME OVER MODAL -->
<div id="modal-over" class="modal">
    <h1 style="color:red; font-size:2.5rem; text-align: center; margin-bottom: 10px;">GAME OVER</h1>
    <h2 id="end-score" style="color:white; font-size: 2rem;">0</h2>
    <p id="end-msg" style="color:gold; font-family: var(--font-retro); font-size: 0.8rem; text-align: center; line-height: 1.5; margin-bottom: 30px;"></p>
    <button class="btn btn-duel" style="width:240px;" id="btn-play-again" onclick="restartGameFromModal()">PLAY AGAIN</button>
    <button class="btn btn-outline" style="width:240px; margin-top: 10px;" onclick="location.reload()">EXIT TO MENU</button>
</div>

<script>
    const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');canvas.width=240;canvas.height=400;const API="https://tg-game-arena.onrender.com",ADMIN_ID=1463465416,tg=window.Telegram.WebApp;tg.ready();tg.expand();let user=null,lobby=null,poll=null,loop=null,gameType='',score=0,isRanked=false,timeLeft=0,matchTimer=0;const keys={left:false,right:false,up:false,down:false,action:false};window.press=(k,s)=>{Reflect.set(keys,k,s);if(s&&window.onInput)window.onInput(k)};document.onkeydown=e=>{if(e.key==='ArrowLeft')press('left',true);if(e.key==='ArrowRight')press('right',true);if(e.key==='ArrowDown')press('down',true);if(e.key==='ArrowUp')press('up',true);if(e.key===' ')press('action',true)};document.onkeyup=e=>{if(e.key==='ArrowLeft')press('left',false);if(e.key==='ArrowRight')press('right',false);if(e.key==='ArrowDown')press('down',false);if(e.key==='ArrowUp')press('up',false);if(e.key===' ')press('action',false)};function updateScore(){document.getElementById('g-score').innerText=score}function checkTime(){if(!isRanked)return false;let n=Date.now();if(n-matchTimer>=1000){timeLeft--;matchTimer=n;document.getElementById('g-time').innerText=timeLeft;if(timeLeft<=0){gameOver();return true}}return false}async function init(){const r=await fetch(API+'/api/user-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});user=await r.json();updateUI();if(user.telegramId===ADMIN_ID)document.getElementById('admin-panel').style.display='block'}init();function updateUI(){document.getElementById('p-bal').innerText=user.balance;document.getElementById('p-id').innerText=user.telegramId;document.getElementById('p-snake').innerText=Reflect.get(user.highScores,'snake')||0;document.getElementById('p-tetris').innerText=Reflect.get(user.highScores,'tetris')||0;document.getElementById('p-battle').innerText=Reflect.get(user.highScores,'battleCity')||0;document.getElementById('p-road').innerText=Reflect.get(user.highScores,'roadFighter')||0;document.getElementById('p-space').innerText=Reflect.get(user.highScores,'spaceInvaders')||0;document.getElementById('p-hockey').innerText=Reflect.get(user.highScores,'airHockey')||0}function nav(id,el){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('s-'+id).classList.add('active');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));if(el)el.classList.add('active')}async function startMatchmaking(){const g=document.getElementById('search-game').value,b=parseInt(document.getElementById('search-bet').value);if(user.balance<b)return tg.showAlert('Insufficient balance');nav('search');const r=await fetch(API+'/api/search-match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId,gameType:g,betAmount:b})});const d=await r.json();if(d.status==='match_found'){lobby={lobbyId:d.lobbyId,betAmount:b};launchGame(g,true)}else{poll=setInterval(async()=>{const cr=await fetch(API+'/api/check-match-status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId})});const cd=await cr.json();if(cd.status==='match_found'){clearInterval(poll);lobby=cd.lobby;launchGame(lobby.gameType,true)}},3000)}}async function cancelMatchmaking(){clearInterval(poll);await fetch(API+'/api/cancel-match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId})});location.reload()}function drawCountdownText(t){ctx.fillStyle='#000';ctx.fillRect(0,0,240,400);ctx.fillStyle='#fff';ctx.font='30px "Press Start 2P"';ctx.textAlign='center';ctx.fillText(t,120,200)}function startCountdown(t){let c=3;drawCountdownText(c);let i=setInterval(()=>{c--;if(c>0)drawCountdownText(c);else if(c===0)drawCountdownText('GO!');else{clearInterval(i);switchGame(t)}},1000)}function launchGame(t,r){gameType=t;isRanked=r;score=0;updateScore();timeLeft=r?60:0;Reflect.set(keys,'left',false);Reflect.set(keys,'right',false);Reflect.set(keys,'up',false);Reflect.set(keys,'down',false);Reflect.set(keys,'action',false);document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('s-game').classList.add('active');document.querySelector('.tabs').style.display='none';document.getElementById('g-time-box').style.display=r?'inline':'none';if(loop){clearTimeout(loop);cancelAnimationFrame(loop);loop=null}startCountdown(t)}function switchGame(t){if(t==='snake')runSnake();else if(t==='tetris')runTetris();else if(t==='battleCity')runBattleCity();else if(t==='roadFighter')runRoadFighter();else if(t==='spaceInvaders')runSpaceInvaders();else if(t==='airHockey')runAirHockey()}async function gameOver(){if(loop){clearTimeout(loop);cancelAnimationFrame(loop)}loop=null;document.getElementById('modal-over').style.display='flex';document.getElementById('end-score').innerText=score;const p=document.getElementById('btn-play-again');if(lobby||isRanked){p.style.display='none';document.getElementById('end-msg').innerText='Waiting for opponent...'}else{p.style.display='block';document.getElementById('end-msg').innerText=''}await fetch(API+'/api/submit-score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId,game:gameType,score:score,lobbyId:lobby?lobby.lobbyId:null})})}function restartGameFromModal(){document.getElementById('modal-over').style.display='none';launchGame(gameType,false)}function quitGame(){tg.showConfirm('Forfeit the game?',async function(c){if(!c)return;if(lobby)await fetch(API+'/api/forfeit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId,lobbyId:lobby.lobbyId})});location.reload()})}async function depositCrypto(a,ca,sa){const r=await fetch(API+'/api/deposit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId,asset:a,amount:ca,stars:sa})});const d=await r.json();if(d.payUrl){tg.openTelegramLink(d.payUrl);let t=setInterval(async()=>{const c=await fetch(API+'/api/user-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData:tg.initData})});const u=await c.json();if(u.balance>user.balance){user.balance=u.balance;updateUI();clearInterval(t);tg.showAlert('Balance updated!')}},3000);setTimeout(()=>clearInterval(t),300000)}else{tg.showAlert('Invoice error')}}function withdraw(){if(user.balance<=0)return tg.showAlert('Empty balance');tg.showConfirm('Withdraw '+user.balance+' Stars?',async function(c){if(!c)return;const r=await fetch(API+'/api/withdraw',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({telegramId:user.telegramId,amount:user.balance})});const d=await r.json();if(d.success){user.balance=d.newBalance;updateUI();tg.showAlert('Request sent!')}else tg.showAlert(d.error)})}async function loadAdminData(){const r=await fetch(API+'/api/admin/data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.telegramId})});const d=await r.json();document.getElementById('adm-commission').innerText=(d.adminCommission||0)+'‚òÖ'}
    function runSnake(){let s=Array.of({x:5,y:10}),f={x:2,y:2},dx=0,dy=-1,fr=0;window.onInput=k=>{if(k==='left'&&dx!==1){dx=-1;dy=0}if(k==='right'&&dx!==-1){dx=1;dy=0}if(k==='up'&&dy!==1){dx=0;dy=-1}if(k==='down'&&dy!==-1){dx=0;dy=1}};function tick(){if(checkTime()||!loop)return;if(++fr%Math.max(5,10-Math.floor(score/50))===0){let h={x:s.at(0).x+dx,y:s.at(0).y+dy};let ht=s.some(p=>p.x===h.x&&p.y===h.y);if(h.x<0||h.x>=12||h.y<0||h.y>=20||ht)return gameOver();s.unshift(h);if(h.x===f.x&&h.y===f.y){score+=10;updateScore();f={x:Math.floor(Math.random()*12),y:Math.floor(Math.random()*20)}}else s.pop()}ctx.fillStyle='#000';ctx.fillRect(0,0,240,400);ctx.fillStyle='#ff0055';ctx.fillRect(f.x*20,f.y*20,19,19);ctx.fillStyle='#00f0ff';s.forEach(p=>ctx.fillRect(p.x*20,p.y*20,19,19));loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
    function runTetris(){const R=20,C=12;let bd=Array.from({length:R},()=>Array.from({length:C},()=>0));const S_S="1111,111-010,11-11,110-011,011-110,111-100,111-001".split(','),SH=new Array();for(let i=0;i<S_S.length;i++){let r=S_S.at(i).split('-'),m=new Array();for(let j=0;j<r.length;j++){let c=r.at(j).split(''),nr=new Array();for(let k=0;k<c.length;k++)nr.push(Number(c.at(k)));m.push(nr)}SH.push(m)}const CL=",-#00f0ff,-#bc13fe,-#ffff00,-#ff0055,-#00ff00,-#ff8800,-#0000ff".split(',');let p={m:SH.at(Math.floor(Math.random()*7)),c:Math.floor(Math.random()*7)+1,x:4,y:0},dC=0,lT=Date.now();window.onInput=k=>{if(k==='left'&&!coll(-1,0,p.m))p.x--;if(k==='right'&&!coll(1,0,p.m))p.x++;if(k==='down'&&!coll(0,1,p.m))p.y++;if(k==='up'||k==='action')rot(p.m)};function dr(){ctx.fillStyle='#000';ctx.fillRect(0,0,240,400);for(let y=0;y<R;y++)for(let x=0;x<C;x++){let v=bd.at(y).at(x);if(v!==0){ctx.fillStyle=CL.at(v);ctx.fillRect(x*20,y*20,19,19)}}for(let y=0;y<p.m.length;y++)for(let x=0;x<p.m.at(y).length;x++)if(p.m.at(y).at(x)!==0){ctx.fillStyle=CL.at(p.c);ctx.fillRect((p.x+x)*20,(p.y+y)*20,19,19)}}function coll(ax,ay,m){for(let y=0;y<m.length;y++)for(let x=0;x<m.at(y).length;x++)if(m.at(y).at(x)!==0){let nx=p.x+x+ax,ny=p.y+y+ay;if(nx<0||nx>=C||ny>=R)return true;let tr=bd.at(ny);if(tr&&tr.at(nx)!==0)return true}return false}function rot(m){let nm=new Array();for(let i=0;i<m.at(0).length;i++){let row=new Array();for(let j=m.length-1;j>=0;j--)row.push(m.at(j).at(i));nm.push(row)}if(!coll(0,0,nm))p.m=nm}function tick(){if(checkTime()||!loop)return;let now=Date.now(),dt=now-lT;lT=now;dC+=dt;if(dC>1000){if(!coll(0,1,p.m))p.y++;else{for(let y=0;y<p.m.length;y++)for(let x=0;x<p.m.at(y).length;x++)if(p.m.at(y).at(x)!==0)Reflect.set(bd.at(y+p.y),x+p.x,p.c);for(let y=R-1;y>=0;y--){let iF=true;for(let x=0;x<C;x++)if(bd.at(y).at(x)===0)iF=false;if(iF){bd.splice(y,1);bd.unshift(Array.from({length:C},()=>0));score+=100;updateScore();y++}}p={m:SH.at(Math.floor(Math.random()*7)),c:Math.floor(Math.random()*7)+1,x:4,y:0};if(coll(0,0,p.m))return gameOver()}dC=0}dr();loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
    function runBattleCity(){let px=5,py=18,dir='up',bl=new Array(),mp=new Array(),en=new Array();for(let r=0;r<20;r++){let row=new Array();for(let c=0;c<12;c++)row.push(r%2!==0&&c%2!==0?2:Math.random()<0.3?1:0);mp.push(row)}mp.at(18).splice(5,1,0);mp.at(1).splice(1,1,0);mp.at(1).splice(10,1,0);window.onInput=k=>{if(k==='action'&&bl.length<2){let bdx=0,bdy=0;if(dir==='up')bdy=-1;if(dir==='down')bdy=1;if(dir==='left')bdx=-1;if(dir==='right')bdx=1;bl.push({x:px,y:py,dx:bdx,dy:bdy,isE:false})}};function mv(dx,dy){let nx=px+dx,ny=py+dy;if(nx>=0&&nx<12&&ny>=0&&ny<20&&mp.at(ny).at(nx)===0){px=nx;py=ny}}function mvE(e,dx,dy){let nx=e.x+dx,ny=e.y+dy;if(nx>=0&&nx<12&&ny>=0&&ny<20&&mp.at(ny).at(nx)===0){e.x=nx;e.y=ny;return true}return false}let fr=0,mD=0;function tick(){if(checkTime()||!loop)return;fr++;mD++;if(mD>6){if(keys.left){dir='left';mv(-1,0);mD=0}else if(keys.right){dir='right';mv(1,0);mD=0}else if(keys.up){dir='up';mv(0,-1);mD=0}else if(keys.down){dir='down';mv(0,1);mD=0}}if(fr%100===0&&en.length<4){let ex=Math.random()<0.5?1:10;en.push({x:ex,y:1,dir:'down'})}if(fr%30===0)for(let i=0;i<en.length;i++){let e=en.at(i);if(Math.random()<0.3){let d=Array.of('u','d','l','r');e.dir=d.at(Math.floor(Math.random()*4))}let dx=0,dy=0;if(e.dir==='u')dy=-1;if(e.dir==='d')dy=1;if(e.dir==='l')dx=-1;if(e.dir==='r')dx=1;if(!mvE(e,dx,dy)){let d=Array.of('u','d','l','r');e.dir=d.at(Math.floor(Math.random()*4))}if(Math.random()<0.1)bl.push({x:e.x,y:e.y,dx:dx,dy:dy,isE:true})}if(fr%5===0){let nB=new Array();for(let i=0;i<bl.length;i++){let b=bl.at(i);b.x+=b.dx;b.y+=b.dy;if(b.x<0||b.x>=12||b.y<0||b.y>=20)continue;let t=mp.at(b.y).at(b.x);if(t===2)continue;if(t===1){mp.at(b.y).splice(b.x,1,0);continue}let hE=false;if(!b.isE){for(let e=0;e<en.length;e++){let E=en.at(e);if(E.x===b.x&&E.y===b.y){en.splice(e,1);score+=50;updateScore();hE=true;break}}}else if(px===b.x&&py===b.y)return gameOver();if(!hE)nB.push(b)}bl=nB}for(let e=0;e<en.length;e++)if(en.at(e).x===px&&en.at(e).y===py)return gameOver();ctx.fillStyle='#000';ctx.fillRect(0,0,240,400);for(let r=0;r<20;r++)for(let c=0;c<12;c++){let t=mp.at(r).at(c);if(t===1){ctx.fillStyle='#A0522D';ctx.fillRect(c*20+1,r*20+1,18,18)}if(t===2){ctx.fillStyle='#888';ctx.fillRect(c*20,r*20,20,20)}}ctx.fillStyle='#00f0ff';ctx.fillRect(px*20+2,py*20+2,16,16);ctx.fillStyle='#fff';if(dir==='up')ctx.fillRect(px*20+8,py*20-2,4,10);if(dir==='down')ctx.fillRect(px*20+8,py*20+12,4,10);if(dir==='left')ctx.fillRect(px*20-2,py*20+8,10,4);if(dir==='right')ctx.fillRect(px*20+12,py*20+8,10,4);ctx.fillStyle='#ff0055';for(let e=0;e<en.length;e++)ctx.fillRect(en.at(e).x*20+2,en.at(e).y*20+2,16,16);ctx.fillStyle='#fff';for(let i=0;i<bl.length;i++)ctx.fillRect(bl.at(i).x*20+8,bl.at(i).y*20+8,4,4);loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
    function runRoadFighter(){let px=110,py=340,pw=20,ph=30,s=0,d=0,e=new Array(),l=0;function tick(){if(checkTime()||!loop)return;if(keys.up||keys.action){s+=0.1;if(s>8)s=8}else{s-=0.2;if(s<0)s=0}if(keys.left)px-=3;if(keys.right)px+=3;if(px<40||px>180)s*=0.5;d+=s;l+=s;if(d>100){score+=10;d=0;updateScore()}if(Math.random()<0.02&&s>2){let ex=50+Math.random()*120;e.push({x:ex,y:-40,s:2+Math.random()*2})}let nE=new Array();for(let i=0;i<e.length;i++){let en=e.at(i);en.y+=(s-en.s);if(px<en.x+20&&px+pw>en.x&&py<en.y+30&&py+ph>en.y)return gameOver();if(en.y<450)nE.push(en)}e=nE;ctx.fillStyle='#228B22';ctx.fillRect(0,0,240,400);ctx.fillStyle='#555';ctx.fillRect(40,0,160,400);ctx.fillStyle='#fff';let o=l%40;for(let y=-40;y<440;y+=40)ctx.fillRect(118,y+o,4,20);ctx.fillStyle='#00f0ff';ctx.fillRect(px,py,pw,ph);ctx.fillStyle='#ff0055';for(let i=0;i<e.length;i++)ctx.fillRect(e.at(i).x,e.at(i).y,20,30);loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
    function runSpaceInvaders(){let px=110,py=360,pw=20,bl=new Array(),eB=new Array(),en=new Array();for(let r=0;r<4;r++)for(let c=0;c<6;c++)en.push({x:20+c*30,y:30+r*30,a:true});let eD=1,eS=0.5;window.onInput=k=>{if((k==='action'||k==='up')&&bl.length<2)bl.push({x:px+8,y:py})};function tick(){if(checkTime()||!loop)return;if(keys.left)px-=3;if(keys.right)px+=3;px=Math.max(0,Math.min(240-pw,px));let nB=new Array();for(let i=0;i<bl.length;i++){let b=bl.at(i);b.y-=5;let h=false;for(let e=0;e<en.length;e++){let E=en.at(e);if(E.a&&b.x>E.x&&b.x<E.x+20&&b.y>E.y&&b.y<E.y+20){E.a=false;h=true;score+=20;updateScore();eS+=0.05;break}}if(!h&&b.y>0)nB.push(b)}bl=nB;let hW=false,aC=0;for(let e=0;e<en.length;e++){let E=en.at(e);if(!E.a)continue;aC++;E.x+=eD*eS;if(E.x<5||E.x>215)hW=true;if(Math.random()<0.005)eB.push({x:E.x+10,y:E.y+20});if(E.y>340)return gameOver()}if(hW){eD*=-1;for(let e=0;e<en.length;e++)en.at(e).y+=15}if(aC===0)for(let r=0;r<4;r++)for(let c=0;c<6;c++)en.push({x:20+c*30,y:30+r*30,a:true});let nEB=new Array();for(let i=0;i<eB.length;i++){let eb=eB.at(i);eb.y+=4;if(eb.x>px&&eb.x<px+pw&&eb.y>py&&eb.y<py+20)return gameOver();if(eb.y<400)nEB.push(eb)}eB=nEB;ctx.fillStyle='#000';ctx.fillRect(0,0,240,400);ctx.fillStyle='#00f0ff';ctx.fillRect(px,py,pw,20);ctx.fillStyle='#bc13fe';for(let e=0;e<en.length;e++){let E=en.at(e);if(E.a)ctx.fillRect(E.x,en.at(e).y,20,20)}ctx.fillStyle='#fff';for(let i=0;i<bl.length;i++)ctx.fillRect(bl.at(i).x,bl.at(i).y,4,10);ctx.fillStyle='#ff0';for(let i=0;i<eB.length;i++)ctx.fillRect(eB.at(i).x,eB.at(i).y,4,10);loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
    function runAirHockey(){let p={x:120,y:320,r:15},e={x:120,y:80,r:15},puck={x:120,y:200,r:10,vx:0,vy:2};let pS=0,eS=0;function resetPuck(){puck.x=120;puck.y=200;puck.vx=0;puck.vy=Math.random()>0.5?2:-2}function tick(){if(checkTime()||!loop)return;if(keys.left)p.x-=3;if(keys.right)p.x+=3;if(keys.up)p.y-=3;if(keys.down)p.y+=3;p.x=Math.max(p.r,Math.min(240-p.r,p.x));p.y=Math.max(200+p.r,Math.min(400-p.r,p.y));e.x+=(puck.x-e.x)*0.1;e.x=Math.max(e.r,Math.min(240-e.r,e.x));puck.x+=puck.vx;puck.y+=puck.vy;puck.vx*=0.99;puck.vy*=0.99;if(puck.x<puck.r||puck.x>240-puck.r)puck.vx*=-1;if(puck.y<0){if(puck.x>80&&puck.x<160){pS++;score=pS-eS;updateScore();resetPuck()}else puck.vy*=-1}if(puck.y>400){if(puck.x>80&&puck.x<160){eS++;score=pS-eS;updateScore();resetPuck()}else puck.vy*=-1}let dx=puck.x-p.x,dy=puck.y-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d<puck.r+p.r){puck.vx=dx*0.2;puck.vy=dy*0.2}dx=puck.x-e.x;dy=puck.y-e.y;d=Math.sqrt(dx*dx+dy*dy);if(d<puck.r+e.r){puck.vx=dx*0.2;puck.vy=dy*0.2}ctx.fillStyle='#006400';ctx.fillRect(0,0,240,400);ctx.strokeStyle='#FFF';ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(0,200);ctx.lineTo(240,200);ctx.stroke();ctx.beginPath();ctx.arc(120,200,30,0,2*Math.PI);ctx.stroke();ctx.fillStyle='#ff0055';ctx.fillRect(80,398,80,2);ctx.fillStyle='#00f0ff';ctx.fillRect(80,0,80,2);ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(puck.x,puck.y,puck.r,0,2*Math.PI);ctx.fill();ctx.fillStyle='#00f0ff';ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,2*Math.PI);ctx.fill();ctx.fillStyle='#ff0055';ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,2*Math.PI);ctx.fill();ctx.fillStyle='#fff';ctx.font='16px "Press Start 2P"';ctx.textAlign='center';ctx.fillText(pS,220,220);ctx.fillText(eS,220,180);if(isRanked&&(pS>=5||eS>=5))return gameOver();loop=requestAnimationFrame(tick)}matchTimer=Date.now();loop=requestAnimationFrame(tick)}
</script>
</body>
</html>
