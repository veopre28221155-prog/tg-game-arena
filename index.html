<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-bg: #1a1a1a; --tg-panel: #2c2c2c; --accent: #ffcc00; }
        body { background: var(--tg-bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        /* Вкладки */
        .tab-content { display: none; padding: 20px; height: 100vh; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; }
        
        .card { background: var(--tg-panel); border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; }
        .balance-val { font-size: 32px; font-weight: bold; color: var(--accent); }
        
        /* Сетка игры */
        #game-canvas { background: #000; border: 2px solid #333; display: block; margin: 0 auto; touch-action: none; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; width: 200px; align-self: center; }
        .ctrl-btn { background: #444; border: none; padding: 20px; border-radius: 10px; color: white; font-weight: bold; }
        
        /* Навигация снизу */
        .nav { position: fixed; bottom: 0; width: 100%; background: #222; display: flex; border-top: 1px solid #333; }
        .nav-btn { flex: 1; padding: 15px; text-align: center; color: #888; cursor: pointer; }
        .nav-btn.active-tab { color: var(--accent); font-weight: bold; }
        
        .btn { background: #2481cc; color: white; border: none; border-radius: 10px; padding: 15px; font-weight: bold; width: 100%; margin: 10px 0; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="tab-profile" class="tab-content active">
        <div class="card">
            <h2 id="name">Загрузка...</h2>
            <div class="balance-val">⭐ <span id="balance">0</span></div>
        </div>
        <div class="card">
            <h3>Пополнение</h3>
            <input type="number" id="pay-amount" value="10" min="10">
            <button class="btn" onclick="pay()">КУПИТЬ STARS</button>
        </div>
    </div>

    <div id="tab-arena" class="tab-content">
        <div style="text-align: center; margin-bottom: 10px;">
            <span>Счет: <b id="score">0</b></span>
        </div>
        <canvas id="game-canvas" width="300" height="300"></canvas>
        
        <div class="controls">
            <div></div><button class="ctrl-btn" onclick="changeDir('up')">↑</button><div></div>
            <button class="ctrl-btn" onclick="changeDir('left')">←</button>
            <button class="ctrl-btn" onclick="changeDir('down')">↓</button>
            <button class="ctrl-btn" onclick="changeDir('right')">→</button>
        </div>
        
        <button id="start-btn" class="btn" onclick="startGame()" style="margin-top:20px;">ИГРАТЬ (50 ⭐)</button>
    </div>

    <div class="nav">
        <div class="nav-btn active-tab" onclick="showTab('profile', this)">ПРОФИЛЬ</div>
        <div class="nav-btn" onclick="showTab('arena', this)">АРЕНА</div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    tg.expand();

    // Переключение вкладок
    function showTab(name, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-tab'));
        document.getElementById('tab-' + name).classList.add('active');
        el.classList.add('active-tab');
    }

    // Логика кошелька
    async function load() {
        const r = await fetch(`${API}/api/user-data`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData })
        });
        const d = await r.json();
        document.getElementById('name').innerText = d.name;
        document.getElementById('balance').innerText = d.balance;
    }

    async function pay() {
        const amount = document.getElementById('pay-amount').value;
        const r = await fetch(`${API}/api/create-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ initData: tg.initData, amount: parseInt(amount) })
        });
        const res = await r.json();
        if(res.invoiceLink) tg.openInvoice(res.invoiceLink, (s) => { if(s=='paid') load(); });
    }

    // ЛОГИКА ЗМЕЙКИ
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let snake, food, direction, gameInterval, score;
    const box = 15;

    function startGame() {
        document.getElementById('start-btn').style.display = 'none';
        snake = [{x: 10 * box, y: 10 * box}];
        food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };
        direction = 'right';
        score = 0;
        if(gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(draw, 150);
    }

    function changeDir(d) { direction = d; }

    function draw() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for(let i=0; i<snake.length; i++) {
            ctx.fillStyle = (i == 0) ? "#ffcc00" : "#fff";
            ctx.fillRect(snake[i].x, snake[i].y, box, box);
        }

        ctx.fillStyle = "red";
        ctx.fillRect(food.x, food.y, box, box);

        let headX = snake[0].x;
        let headY = snake[0].y;

        if(direction == 'left') headX -= box;
        if(direction == 'up') headY -= box;
        if(direction == 'right') headX += box;
        if(direction == 'down') headY += box;

        if(headX == food.x && headY == food.y) {
            score++;
            document.getElementById('score').innerText = score;
            food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };
        } else {
            snake.pop();
        }

        let newHead = {x: headX, y: headY};

        if(headX < 0 || headX >= canvas.width || headY < 0 || headY >= canvas.height || collision(newHead, snake)) {
            clearInterval(gameInterval);
            tg.showAlert("Игра окончена! Счет: " + score);
            document.getElementById('start-btn').style.display = 'block';
        }

        snake.unshift(newHead);
    }

    function collision(head, array) {
        for(let i=0; i<array.length; i++) {
            if(head.x == array[i].x && head.y == array[i].y) return true;
        }
        return false;
    }

    load();
</script>
</body>
</html>
