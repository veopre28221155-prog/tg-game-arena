<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-bg: #ffffff; --tg-btn: #2481cc; --tg-text: #000000; }
        body { background: var(--tg-bg); color: var(--tg-text); font-family: sans-serif; margin: 0; padding: 20px; text-align: center; }
        .card { background: #f0f0f2; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn { background: var(--tg-btn); color: #fff; border: none; border-radius: 10px; padding: 16px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        #debug-log { font-size: 10px; color: #888; margin-top: 20px; text-align: left; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="user-name">Загрузка...</h2>
        <div style="font-size: 36px; font-weight: bold;">⭐ <span id="user-balance">0</span></div>
    </div>
    
    <button class="btn" onclick="topUp()">ПОПОЛНИТЬ БАЛАНС (50 ⭐)</button>

    <div id="debug-log">Статус: Инициализация...</div>

    <script>
        const tg = window.Telegram.WebApp;
        const API = 'https://tg-game-arena.onrender.com';
        tg.expand();

        function log(msg) { document.getElementById('debug-log').innerText += "\n> " + msg; }

        async function loadProfile() {
            try {
                log("Запрос к серверу...");
                const response = await fetch(`${API}/api/user-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const user = await response.json();
                document.getElementById('user-name').innerText = user.name;
                document.getElementById('user-balance').innerText = user.balance;
                log("Данные загружены ✅");
            } catch (e) {
                log("Ошибка связи: " + e.message);
            }
        }

        async function topUp() {
            log("Создание счета...");
            try {
                const response = await fetch(`${API}/api/create-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData, amount: 50 })
                });
                const data = await response.json();
                if (data.invoiceLink) {
                    log("Счет готов, открываю окно оплаты...");
                    tg.openInvoice(data.invoiceLink, (status) => {
                        log("Результат оплаты: " + status);
                        if (status === 'paid') loadProfile();
                    });
                } else {
                    log("Ошибка: Сервер не прислал ссылку");
                }
            } catch (e) {
                log("Ошибка сети: " + e.message);
            }
        }

        loadProfile();
    </script>
</body>
</html>
