<!DOCTYPE html><html lang="ru"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retro Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #fff; --btn: #2481cc; --sec: #f0f0f2; --text: #000; }
        body { background: var(--sec); color: var(--text); margin: 0; font-family: sans-serif; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; height: 100vh; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        .screen { display: none; flex: 1; padding: 16px; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }
        .card { background: var(--sec); border-radius: 12px; width: 100%; padding: 16px; margin-bottom: 12px; text-align: center; box-sizing: border-box; }
        .btn { background: var(--btn); color: #fff; border: none; border-radius: 10px; padding: 14px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; margin: 6px 0; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; text-align: center; font-size: 18px; }
        canvas { background: #000; border-radius: 8px; display: none; }
        #nav { display: flex; background: var(--bg); height: 65px; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #999; font-size: 14px; }
        .nav-item.active { color: var(--btn); font-weight: bold; }
        #result-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #fff; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style></head><body><div id="app">
    
    <div id="result-overlay">
        <h2>–ú–∞—Ç—á –æ–∫–æ–Ω—á–µ–Ω</h2>
        <p id="res-score">–í—ã: 0 | –°–æ–ø–µ—Ä–Ω–∏–∫: 0</p>
        <button class="btn" onclick="preStart(isPractice)">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        <button class="btn" style="background:#444" onclick="location.reload()">–í –º–µ–Ω—é</button>
    </div>

    <div id="arena" class="screen active">
        <div class="card">
            <h3>–ò–≥—Ä—ã</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="s-snake" onclick="setGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
                <button class="btn" id="s-tetris" onclick="setGame('tetris')" style="opacity:0.5">üß± –¢–µ—Ç—Ä–∏—Å</button>
            </div>
        </div>
        <div id="arena-menu" class="card">
            <h4 id="mode-info">–í—ã–±—Ä–∞–Ω–æ: –ó–º–µ–π–∫–∞</h4>
            <button class="btn" onclick="preStart(true)">üî• –¢–†–ï–ù–ò–†–û–í–ö–ê</button>
            <button class="btn" style="background:none; color:var(--btn); border:1px solid var(--btn)" id="friend-btn">‚öîÔ∏è –ò–ì–†–ê–¢–¨ –° –î–†–£–ì–û–ú</button>
        </div>
        <div id="game-ui" style="display:none; flex-direction:column; align-items:center; width:100%;">
            <div id="countdown" style="font-size:40px; font-weight:bold; margin:10px; color:var(--btn)">3</div>
            <div id="score-text" style="font-weight:bold; margin-bottom:5px;">Score: 0</div>
            <canvas id="gameCanvas" width="300" height="450"></canvas>
            <button class="btn" style="background:red; width:120px; margin-top:10px;" onclick="location.reload()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div id="profile" class="screen">
        <div class="card">
            <h2 id="u-name">Player</h2>
            <div style="font-size:36px; font-weight:bold; color:var(--btn)">‚≠ê <span id="u-balance">0</span></div>
        </div>
        <div class="card">
            <h4>–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h4>
            <input type="number" id="pay-amt" value="50" min="10">
            <button class="btn" onclick="pay()">–ö–£–ü–ò–¢–¨ STARS</button>
        </div>
    </div>

    <nav id="nav">
        <div class="nav-item active" onclick="tab('arena', this)">–ê–†–ï–ù–ê</div>
        <div class="nav-item" onclick="tab('profile', this)">–ü–†–û–§–ò–õ–¨</div>
    </nav>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://tg-game-arena.onrender.com';
    let balance = 0, currentGame = 'snake', moveDir = {x:1, y:0}, isPractice = true;
    let gameLoop, currentLobbyId = null, currentScore = 0;

    tg.expand();
    tg.ready();

    // 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ö (–°—Ç—Ä–µ–ª–∫–∏)
    window.addEventListener('keydown', (e) => {
        if (currentGame === 'snake') {
            if (e.key === 'ArrowUp' && moveDir.y === 0) moveDir = {x:0, y:-1};
            if (e.key === 'ArrowDown' && moveDir.y === 0) moveDir = {x:0, y:1};
            if (e.key === 'ArrowLeft' && moveDir.x === 0) moveDir = {x:-1, y:0};
            if (e.key === 'ArrowRight' && moveDir.x === 0) moveDir = {x:1, y:0};
        } else if (currentGame === 'tetris') {
            if (e.key === 'ArrowLeft') tetrisMove(-1);
            if (e.key === 'ArrowRight') tetrisMove(1);
            if (e.key === 'ArrowDown') tetrisDrop();
            if (e.key === 'ArrowUp') tetrisRotate();
        }
    });

    async function load() {
        const r = await fetch(`${API}/api/user-data`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData }) });
        const d = await r.json();
        document.getElementById('u-balance').innerText = d.balance;
        document.getElementById('u-name').innerText = d.name;
    }

    // 2. –†–ê–ë–û–ß–ê–Ø –ö–ù–û–ü–ö–ê –î–†–£–ì–ê
    document.getElementById('friend-btn').addEventListener('click', () => {
        const lobbyId = Math.random().toString(36).substr(2, 9);
        tg.switchInlineQuery(`lobby_${lobbyId}`, ['users', 'chats']);
    });

    async function checkInvite() {
        const startParam = tg.initDataUnsafe.start_param;
        if (startParam && startParam.startsWith('lobby_')) {
            currentLobbyId = startParam.replace('lobby_', '');
            isPractice = false;
            await fetch(`${API}/api/join-lobby`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId }) });
            preStart(false);
        }
    }

    function setGame(g) {
        currentGame = g;
        document.getElementById('s-snake').style.opacity = g === 'snake' ? '1' : '0.5';
        document.getElementById('s-tetris').style.opacity = g === 'tetris' ? '1' : '0.5';
        document.getElementById('mode-info').innerText = "–í—ã–±—Ä–∞–Ω–æ: " + (g === 'snake' ? '–ó–º–µ–π–∫–∞' : '–¢–µ—Ç—Ä–∏—Å');
    }

    function preStart(practice) {
        isPractice = practice;
        document.getElementById('arena-menu').style.display = 'none';
        document.getElementById('result-overlay').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        let c = 3;
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        const t = setInterval(() => {
            cd.innerText = c;
            c--;
            if(c < 0) {
                clearInterval(t);
                cd.style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                if(currentGame === 'snake') runSnake(); else runTetris();
            }
        }, 1000);
    }

    // 3. –ó–ú–ï–ô–ö–ê
    function runSnake() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        let s = [{x:10, y:10}], f = {x:5, y:5};
        currentScore = 0; moveDir = {x:1, y:0};
        gameLoop = setInterval(() => {
            let h = {x: s[0].x + moveDir.x, y: s[0].y + moveDir.y};
            if(h.x<0||h.x>=20||h.y<0||h.y>=30) { stopGame(); return; }
            s.unshift(h);
            if(h.x===f.x && h.y===f.y) {
                currentScore++; document.getElementById('score-text').innerText = "Score: " + currentScore;
                f = {x:Math.floor(Math.random()*20), y:Math.floor(Math.random()*30)};
            } else s.pop();
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,450);
            ctx.fillStyle = "#2481cc"; s.forEach(p=>ctx.fillRect(p.x*15, p.y*15, 14, 14));
            ctx.fillStyle = "red"; ctx.fillRect(f.x*15, f.y*15, 14, 14);
        }, 150);
    }

    // 4. –¢–ï–¢–†–ò–°
    let tBoard, tPiece;
    function runTetris() {
        const cvs = document.getElementById('gameCanvas'), ctx = cvs.getContext('2d');
        tBoard = Array(20).fill().map(() => Array(10).fill(0));
        currentScore = 0; spawnTPiece();
        gameLoop = setInterval(() => { tetrisDrop(); drawTetris(ctx); }, 600);
    }
    function spawnTPiece() {
        const t = 'IJOSTZL'[Math.random()*7|0];
        tPiece = { pos: {x:3, y:0}, matrix: createTPiece(t) };
        if (tCollide()) stopGame();
    }
    function createTPiece(t) {
        if(t==='I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
        if(t==='T') return [[0,1,0],[1,1,1],[0,0,0]];
        if(t==='O') return [[1,1],[1,1]];
        if(t==='L') return [[0,1,0],[0,1,0],[0,1,1]];
        if(t==='J') return [[0,1,0],[0,1,0],[1,1,0]];
        return [[1,1,0],[0,1,1],[0,0,0]];
    }
    function tetrisDrop() {
        tPiece.pos.y++;
        if(tCollide()){ tPiece.pos.y--; tMerge(); spawnTPiece(); tClear(); }
    }
    function tCollide() {
        const [m, o] = [tPiece.matrix, tPiece.pos];
        for(let y=0; y<m.length; y++) for(let x=0; x<m[y].length; x++)
            if(m[y][x] && (tBoard[y+o.y] && tBoard[y+o.y][x+o.x]) !== 0) return true;
        return false;
    }
    function tMerge() { tPiece.matrix.forEach((r,y)=>r.forEach((v,x)=>{ if(v) tBoard[y+tPiece.pos.y][x+tPiece.pos.x]=1; })); }
    function tClear() {
        outer: for(let y=tBoard.length-1; y>0; y--) {
            for(let x=0; x<tBoard[y].length; x++) if(!tBoard[y][x]) continue outer;
            tBoard.splice(y,1); tBoard.unshift(Array(10).fill(0));
            currentScore += 10; document.getElementById('score-text').innerText = "Score: "+currentScore;
            y++;
        }
    }
    function drawTetris(ctx) {
        ctx.fillStyle='#000'; ctx.fillRect(0,0,300,450);
        tBoard.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle='#2481cc'; ctx.fillRect(x*30, y*22.5, 29, 21.5); } }));
        tPiece.matrix.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle='#fff'; ctx.fillRect((x+tPiece.pos.x)*30, (y+tPiece.pos.y)*22.5, 29, 21.5); } }));
    }
    function tetrisMove(d){ tPiece.pos.x += d; if(tCollide()) tPiece.pos.x -= d; }
    function tetrisRotate(){ 
        const old=tPiece.matrix; 
        tPiece.matrix = tPiece.matrix[0].map((_,i)=>tPiece.matrix.map(r=>r[i]).reverse());
        if(tCollide()) tPiece.matrix = old;
    }

    function stopGame() {
        clearInterval(gameLoop);
        if(!isPractice) submitScore(); else tg.showAlert("–°—á–µ—Ç: " + currentScore);
    }

    async function submitScore() {
        const r = await fetch(`${API}/api/submit-score`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, lobbyId: currentLobbyId, score: currentScore }) });
        const l = await r.json();
        document.getElementById('result-overlay').style.display = 'flex';
        document.getElementById('res-score').innerText = "–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥—Ä—É–≥—É!";
    }

    function tab(id, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    async function pay() {
        const a = document.getElementById('pay-amt').value;
        const r = await fetch(`${API}/api/create-invoice`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ initData: tg.initData, amount: parseInt(a) }) });
        const d = await r.json();
        if(d.invoiceLink) tg.openInvoice(d.invoiceLink, (st) => { if(st==='paid') load(); });
    }

    load(); checkInvite();
</script></body></html>
